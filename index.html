<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班级管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        .sidebar-link { 
            @apply flex items-center px-4 py-3 text-gray-200 hover:bg-blue-700 transition-colors duration-200 rounded-md; 
        }
        .sidebar-link.active { @apply bg-blue-700; }
        .sidebar-category { @apply flex items-center justify-between px-4 py-3 text-white font-medium cursor-pointer; }
        .content-card { @apply bg-white rounded-lg shadow-md p-6 mb-6; }
        .page-content { @apply p-6; }
        .nav-item { @apply cursor-pointer; }
        .message-item { @apply border-l-4 border-purple-500 pl-4 py-2 mb-3; }
        .stat-card { @apply bg-white rounded-lg shadow p-4 border-l-4; }
        .transition-height { transition: max-height 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex overflow-hidden">
    <!-- 登录页面 -->
    <div id="login-page" class="w-full min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 sm:p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">班级管理系统</h2>
                    <p class="mt-2 text-gray-500">请登录您的账号</p>
                </div>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">用户名</label>
                        <input type="text" id="username" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">密码</label>
                        <input type="password" id="password" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="user-role" class="block text-sm font-medium text-gray-700">角色</label>
                        <select id="user-role" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="admin">管理员</option>
                            <option value="teacher">教师</option>
                            <option value="student">学生</option>
                        </select>
                    </div>
                    <button type="submit" 
                        class="w-full py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        登录
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div id="app" class="hidden flex h-screen w-full">
        <!-- 侧边栏 -->
        <aside class="bg-blue-800 text-white w-64 flex-shrink-0 overflow-y-auto">
            <div class="p-6 border-b border-blue-700">
                <h1 class="text-xl font-bold">班级管理系统</h1>
            </div>
            
            <!-- 主导航 -->
            <nav class="px-2 py-4">
                <!-- 系统概览 -->
                <div class="mb-2">
                    <div class="sidebar-category" data-category="overview">
                        <span><i class="fa fa-tachometer mr-2"></i>系统概览</span>
                        <i class="fa fa-chevron-down text-xs transition-transform duration-200"></i>
                    </div>
                    <div class="category-content pl-4 pr-2 overflow-hidden max-h-0 transition-height">
                        <a href="#" data-page="dashboard" class="sidebar-link nav-item active block">
                            仪表盘
                        </a>
                    </div>
                </div>

                <!-- 班级管理 -->
                <div class="mb-2">
                    <div class="sidebar-category" data-category="class">
                        <span><i class="fa fa-users mr-2"></i>班级管理</span>
                        <i class="fa fa-chevron-down text-xs transition-transform duration-200"></i>
                    </div>
                    <div class="category-content pl-4 pr-2 overflow-hidden max-h-0 transition-height">
                        <a href="#" data-page="class-members" class="sidebar-link nav-item block">
                            班级成员
                        </a>
                        <a href="#" data-page="committee" class="sidebar-link nav-item block">
                            班委会
                        </a>
                        <a href="#" data-page="schedules" class="sidebar-link nav-item block">
                            值日安排
                        </a>
                        <a href="#" data-page="activities" class="sidebar-link nav-item block">
                            班级活动
                        </a>
                    </div>
                </div>

                <!-- 沟通交流 -->
                <div class="mb-2">
                    <div class="sidebar-category" data-category="communication">
                        <span><i class="fa fa-comments mr-2"></i>沟通交流</span>
                        <i class="fa fa-chevron-down text-xs transition-transform duration-200"></i>
                    </div>
                    <div class="category-content pl-4 pr-2 overflow-hidden max-h-0 transition-height">
                        <a href="#" data-page="messages" class="sidebar-link nav-item block">
                            留言簿
                        </a>
                        <a href="#" data-page="chat" class="sidebar-link nav-item block">
                            实时聊天
                        </a>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- 主内容区 -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- 顶部导航栏 -->
            <header class="bg-white shadow-sm px-6 py-3 flex justify-between items-center">
                <h2 id="page-title" class="text-lg font-semibold">仪表盘</h2>
                <div class="flex items-center">
                    <span id="user-info" class="mr-4"></span>
                    <button id="logout-btn" class="text-gray-600 hover:text-gray-900 transition-colors">
                        <i class="fa fa-sign-out mr-1"></i>退出
                    </button>
                </div>
            </header>

            <!-- 页面内容 -->
            <main class="flex-1 overflow-y-auto bg-gray-100 p-4">
                <!-- 仪表盘页面 -->
                <div id="dashboard-page" class="page-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="stat-card border-blue-500">
                            <div class="text-sm text-gray-500">班级总人数</div>
                            <div class="text-xl font-bold mt-1" id="stat-total-members">0</div>
                        </div>
                        <div class="stat-card border-yellow-500">
                            <div class="text-sm text-gray-500">本月活动</div>
                            <div class="text-xl font-bold mt-1" id="stat-monthly-activities">0</div>
                        </div>
                        <div class="stat-card border-purple-500">
                            <div class="text-sm text-gray-500">最新留言</div>
                            <div class="text-xl font-bold mt-1" id="stat-recent-messages">0</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="content-card">
                            <h3 class="text-lg font-semibold mb-4">本月班级活动统计</h3>
                            <div id="activities-chart" class="h-64 flex items-center justify-center">
                                <p class="text-gray-500">加载统计数据中...</p>
                            </div>
                        </div>
                        <div class="content-card">
                            <h3 class="text-lg font-semibold mb-4">值日完成情况</h3>
                            <div id="schedules-chart" class="h-64 flex items-center justify-center">
                                <p class="text-gray-500">加载统计数据中...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 班级成员页面 -->
                <div id="class-members-page" class="page-content hidden">
                    <div class="content-card">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">班级成员管理</h3>
                            <button id="add-member-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors">
                                <i class="fa fa-plus mr-1"></i>添加成员
                            </button>
                        </div>

                        <div class="mb-4 flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <input type="text" id="member-search" placeholder="搜索姓名或学号..."
                                    class="w-full px-4 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="w-full md:w-40">
                                <select id="member-role-filter" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                                    <option value="">所有角色</option>
                                    <option value="teacher">教师</option>
                                    <option value="student">学生</option>
                                </select>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学号/工号</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">角色</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">联系电话</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="members-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">加载成员数据中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 班委会页面 -->
                <div id="committee-page" class="page-content hidden">
                    <div class="content-card">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">班委会管理</h3>
                            <button id="add-committee-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors">
                                <i class="fa fa-plus mr-1"></i>添加成员
                            </button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学号</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">职务</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">职责</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="committee-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">加载数据中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 值日安排页面 -->
                <div id="schedules-page" class="page-content hidden">
                    <div class="content-card">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                            <h3 class="text-lg font-semibold">值日安排管理</h3>
                            <div class="flex gap-4 w-full md:w-auto">
                                <div class="flex gap-2">
                                    <input type="date" id="schedule-start-date" class="px-4 py-2 border border-gray-300 rounded-md">
                                    <span class="flex items-center">至</span>
                                    <input type="date" id="schedule-end-date" class="px-4 py-2 border border-gray-300 rounded-md">
                                </div>
                                <select id="schedule-status-filter" class="px-4 py-2 border border-gray-300 rounded-md">
                                    <option value="">所有状态</option>
                                    <option value="未开始">未开始</option>
                                    <option value="进行中">进行中</option>
                                    <option value="已完成">已完成</option>
                                </select>
                                <button id="filter-schedules-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                                    <i class="fa fa-filter mr-1"></i>筛选
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">值日人员</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">任务</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                    </tr>
                                </thead>
                                <tbody id="schedules-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">加载值日数据中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 班级活动页面 -->
                <div id="activities-page" class="page-content hidden">
                    <div class="content-card">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                            <h3 class="text-lg font-semibold">班级活动管理</h3>
                            <div class="flex gap-4 w-full md:w-auto">
                                <div class="flex gap-2">
                                    <input type="date" id="activity-start-date" class="px-4 py-2 border border-gray-300 rounded-md">
                                    <span class="flex items-center">至</span>
                                    <input type="date" id="activity-end-date" class="px-4 py-2 border border-gray-300 rounded-md">
                                </div>
                                <select id="activity-type-filter" class="px-4 py-2 border border-gray-300 rounded-md">
                                    <option value="">所有类型</option>
                                    <option value="会议">会议</option>
                                    <option value="比赛">比赛</option>
                                    <option value="志愿活动">志愿活动</option>
                                    <option value="其他">其他</option>
                                </select>
                                <button id="filter-activities-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                                    <i class="fa fa-filter mr-1"></i>筛选
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">活动名称</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建人</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">描述</th>
                                    </tr>
                                </thead>
                                <tbody id="activities-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">加载活动数据中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 留言簿页面 -->
                <div id="messages-page" class="page-content hidden">
                    <div class="content-card">
                        <h3 class="text-lg font-semibold mb-6">班级留言簿</h3>
                        
                        <div class="mb-6">
                            <textarea id="new-message" rows="3" placeholder="输入留言内容..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"></textarea>
                            <div class="mt-2 flex justify-end">
                                <button id="send-message-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                                    <i class="fa fa-paper-plane mr-1"></i>发送留言
                                </button>
                            </div>
                        </div>

                        <div id="messages-list">
                            <p class="text-center text-gray-500 py-6">加载留言数据中...</p>
                        </div>
                    </div>
                </div>

                <!-- 实时聊天页面 -->
                <div id="chat-page" class="page-content hidden">
                    <div class="content-card h-[calc(100vh-12rem)] flex flex-col">
                        <div class="flex-1 flex">
                            <!-- 在线用户列表 -->
                            <div class="w-64 border-r border-gray-200 p-4">
                                <h4 class="font-medium mb-3">在线用户</h4>
                                <div id="online-users-list" class="space-y-2">
                                    <p class="text-sm text-gray-500">加载在线用户中...</p>
                                </div>
                            </div>
                            
                            <!-- 聊天内容 -->
                            <div class="flex-1 flex flex-col">
                                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                                    <p class="text-center text-gray-500 py-6">等待连接...</p>
                                </div>
                                
                                <!-- 发送消息框 -->
                                <div class="border-t border-gray-200 p-4">
                                    <div class="flex gap-2">
                                        <input type="text" id="chat-input" placeholder="输入消息..."
                                            class="flex-1 px-4 py-2 border border-gray-300 rounded-md">
                                        <button id="send-chat-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                                            <i class="fa fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 添加班级成员模态框 -->
    <div id="add-member-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md p-6">
            <h3 class="text-lg font-semibold mb-4">添加班级成员</h3>
            <form id="add-member-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">学号/工号</label>
                    <input type="text" id="member-id" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                    <input type="text" id="member-name" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">角色</label>
                    <select id="member-role" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                        <option value="teacher">教师</option>
                        <option value="student">学生</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">联系电话</label>
                    <input type="text" id="member-phone"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                    <input type="email" id="member-email"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-add-member" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 班委会成员添加模态框 -->
    <div id="add-committee-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md p-6">
            <h3 class="text-lg font-semibold mb-4">添加班委会成员</h3>
            <form id="add-committee-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">学号</label>
                    <input type="text" id="committee-student-id" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                    <input type="text" id="committee-name" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">职务</label>
                    <input type="text" id="committee-position" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="如：班长、学习委员">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">职责</label>
                    <textarea id="committee-responsibilities" rows="2"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="描述职责范围"></textarea>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-add-committee" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 配置信息
        const CONFIG = {
            API_BASE_URL: 'http://localhost:3001/api',
            WS_BASE_URL: 'ws://localhost:3001'
        };

        // 当前登录用户信息
        let currentUser = null;
        // WebSocket连接
        let ws = null;

        // DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化事件绑定
            initEventListeners();
            
            // 检查本地存储的登录状态
            const savedUser = localStorage.getItem('classSystemUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            }
        });

        // 初始化所有事件监听
        function initEventListeners() {
            // 登录表单提交
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // 退出登录
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // 侧边栏分类展开/折叠
            document.querySelectorAll('.sidebar-category').forEach(item => {
                item.addEventListener('click', toggleSidebarCategory);
            });
            
            // 页面导航切换
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', switchPage);
            });
            
            // 班级成员相关事件
            initMemberEvents();
            
            // 班委会相关事件
            initCommitteeEvents();
            
            // 值日安排相关事件
            initScheduleEvents();
            
            // 班级活动相关事件
            initActivityEvents();
            
            // 留言簿相关事件
            initMessageEvents();
            
            // 实时聊天相关事件
            initChatEvents();
        }

        // 1. 登录相关
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('user-role').value;

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, role })
                });

                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('classSystemUser', JSON.stringify(currentUser));
                    showApp();
                } else {
                    alert(data.error || '登录失败');
                }
            } catch (err) {
                console.error('登录错误:', err);
                alert('网络错误或服务器未启动，请检查后端服务');
            }
        }

        function handleLogout() {
            localStorage.removeItem('classSystemUser');
            currentUser = null;
            // 关闭WebSocket连接
            if (ws) {
                ws.close();
                ws = null;
            }
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('user-info').textContent = `${currentUser.username} (${
                currentUser.role === 'admin' ? '管理员' : currentUser.role === 'teacher' ? '教师' : '学生'
            })`;
            
            // 加载默认页面数据
            loadDashboardData();
        }

        // 2. 页面导航
        function toggleSidebarCategory(e) {
            const category = e.currentTarget.getAttribute('data-category');
            const content = e.currentTarget.nextElementSibling;
            const icon = e.currentTarget.querySelector('.fa-chevron-down');
            
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.maxHeight = content.scrollHeight + 'px';
                icon.style.transform = 'rotate(180deg)';
            }
        }

        function switchPage(e) {
            e.preventDefault();
            const pageId = e.currentTarget.getAttribute('data-page');
            
            // 更新活跃导航项
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            e.currentTarget.classList.add('active');
            
            // 显示选中页面，隐藏其他页面
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(`${pageId}-page`).classList.remove('hidden');
            
            // 更新页面标题
            const pageTitle = e.currentTarget.textContent.trim();
            document.getElementById('page-title').textContent = pageTitle;
            
            // 加载对应页面数据
            switch (pageId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'class-members':
                    loadClassMembers();
                    break;
                case 'committee':
                    loadCommitteeMembers();
                    break;
                case 'schedules':
                    loadSchedules();
                    break;
                case 'activities':
                    loadActivities();
                    break;
                case 'messages':
                    loadMessages();
                    break;
                case 'chat':
                    initWebSocket();
                    break;
            }
        }

        // 3. 仪表盘数据
        async function loadDashboardData() {
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/dashboard`);
                if (!response.ok) throw new Error('获取仪表盘数据失败');
                
                const data = await response.json();
                
                // 更新统计数据
                document.getElementById('stat-total-members').textContent = data.totalMembers;
                document.getElementById('stat-monthly-activities').textContent = data.monthlyActivities;
                document.getElementById('stat-recent-messages').textContent = data.recentMessages;
                
                // 加载活动统计图表
                loadActivitiesStats();
                // 加载值日统计图表
                loadSchedulesStats();
            } catch (err) {
                console.error('加载仪表盘数据错误:', err);
                alert('加载仪表盘数据失败');
            }
        }

        async function loadActivitiesStats() {
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/activities/stats`);
                if (!response.ok) throw new Error('获取活动统计失败');
                
                const stats = await response.json();
                const container = document.getElementById('activities-chart');
                
                if (stats.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">暂无活动数据</p>';
                    return;
                }
                
                // 简单文本图表展示
                let chartHtml = '<div class="space-y-2">';
                stats.forEach(item => {
                    chartHtml += `
                        <div>
                            <div class="flex justify-between mb-1">
                                <span>${item.month}</span>
                                <span>${item.count} 次活动</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: ${Math.min(item.count * 10, 100)}%"></div>
                            </div>
                        </div>
                    `;
                });
                chartHtml += '</div>';
                container.innerHTML = chartHtml;
            } catch (err) {
                console.error('加载活动统计错误:', err);
                document.getElementById('activities-chart').innerHTML = '<p class="text-red-500">加载活动统计失败</p>';
            }
        }

        async function loadSchedulesStats() {
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/schedules/stats`);
                if (!response.ok) throw new Error('获取值日统计失败');
                
                const stats = await response.json();
                const container = document.getElementById('schedules-chart');
                
                container.innerHTML = `
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-sm text-gray-500">已完成</div>
                            <div class="text-2xl font-bold text-green-500 mt-1">${stats.completedPercentage}%</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500">进行中</div>
                            <div class="text-2xl font-bold text-yellow-500 mt-1">${stats.inProgressPercentage}%</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500">未开始</div>
                            <div class="text-2xl font-bold text-red-500 mt-1">${stats.notStartedPercentage}%</div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('加载值日统计错误:', err);
                document.getElementById('schedules-chart').innerHTML = '<p class="text-red-500">加载值日统计失败</p>';
            }
        }

        // 4. 班级成员管理
        function initMemberEvents() {
            // 打开添加成员模态框
            document.getElementById('add-member-btn').addEventListener('click', () => {
                openModal('add-member-modal');
            });
            
            // 关闭添加成员模态框
            document.getElementById('cancel-add-member').addEventListener('click', () => {
                closeModal('add-member-modal');
            });
            
            // 提交添加成员表单
            document.getElementById('add-member-form').addEventListener('submit', handleAddMember);
            
            // 搜索和筛选
            document.getElementById('member-search').addEventListener('input', debounce(loadClassMembers, 500));
            document.getElementById('member-role-filter').addEventListener('change', loadClassMembers);
        }

        async function loadClassMembers() {
            const search = document.getElementById('member-search').value;
            const role = document.getElementById('member-role-filter').value;
            const tableBody = document.getElementById('members-table-body');
            
            try {
                let url = `${CONFIG.API_BASE_URL}/class-members`;
                const params = new URLSearchParams();
                if (search) params.append('search', search);
                if (role) params.append('role', role);
                if (params.toString()) url += `?${params.toString()}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('获取成员列表失败');
                
                const members = await response.json();
                
                if (members.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">暂无成员数据</td></tr>';
                    return;
                }
                
                let html = '';
                members.forEach(member => {
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">${member.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${member.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    ${member.role === 'teacher' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                                    ${member.role === 'teacher' ? '教师' : '学生'}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">${member.phone || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button onclick="deleteClassMember('${member.id}')" 
                                    class="text-red-500 hover:text-red-700 transition-colors">
                                    <i class="fa fa-trash"></i> 删除
                                </button>
                            </td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = html;
            } catch (err) {
                console.error('加载班级成员错误:', err);
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">加载失败</td></tr>';
            }
        }

        async function handleAddMember(e) {
            e.preventDefault();
            const memberData = {
                id: document.getElementById('member-id').value,
                name: document.getElementById('member-name').value,
                role: document.getElementById('member-role').value,
                phone: document.getElementById('member-phone').value,
                email: document.getElementById('member-email').value
            };

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/class-members`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(memberData)
                });

                if (!response.ok) throw new Error('添加成员失败');
                
                const data = await response.json();
                if (data.success) {
                    closeModal('add-member-modal');
                    document.getElementById('add-member-form').reset();
                    loadClassMembers(); // 刷新列表
                    alert('添加成功');
                } else {
                    alert(data.error || '添加失败');
                }
            } catch (err) {
                console.error('添加班级成员错误:', err);
                alert('网络错误，添加失败');
            }
        }

        async function deleteClassMember(id) {
            if (!confirm('确定要删除该成员吗？')) return;

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/class-members/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('删除成员失败');
                
                const data = await response.json();
                if (data.success) {
                    loadClassMembers(); // 刷新列表
                    alert('删除成功');
                } else {
                    alert(data.error || '删除失败');
                }
            } catch (err) {
                console.error('删除班级成员错误:', err);
                alert('网络错误，删除失败');
            }
        }

        // 5. 班委会管理
        function initCommitteeEvents() {
            // 打开添加模态框
            document.getElementById('add-committee-btn').addEventListener('click', () => {
                openModal('add-committee-modal');
            });
            
            // 关闭添加模态框
            document.getElementById('cancel-add-committee').addEventListener('click', () => {
                closeModal('add-committee-modal');
            });
            
            // 提交添加表单
            document.getElementById('add-committee-form').addEventListener('submit', handleAddCommitteeMember);
        }

        async function loadCommitteeMembers() {
            const tableBody = document.getElementById('committee-table-body');
            
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/committee`);
                if (!response.ok) throw new Error('获取班委会成员失败');
                
                const members = await response.json();
                
                if (members.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">暂无数据</td></tr>';
                    return;
                }
                
                let html = '';
                members.forEach(member => {
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">${member.student_id}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${member.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${member.position}</td>
                            <td class="px-6 py-4">${member.responsibilities || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button onclick="deleteCommitteeMember(${member.id})" 
                                    class="text-red-500 hover:text-red-700 transition-colors">
                                    <i class="fa fa-trash"></i> 删除
                                </button>
                            </td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = html;
            } catch (err) {
                console.error('加载班委会成员错误:', err);
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">加载失败</td></tr>';
            }
        }

        async function handleAddCommitteeMember(e) {
            e.preventDefault();
            const committeeData = {
                student_id: document.getElementById('committee-student-id').value,
                name: document.getElementById('committee-name').value,
                position: document.getElementById('committee-position').value,
                responsibilities: document.getElementById('committee-responsibilities').value
            };

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/committee`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(committeeData)
                });

                if (!response.ok) throw new Error('添加班委会成员失败');
                
                const data = await response.json();
                if (data.success) {
                    closeModal('add-committee-modal');
                    document.getElementById('add-committee-form').reset();
                    loadCommitteeMembers(); // 刷新列表
                    alert('添加成功');
                } else {
                    alert(data.error || '添加失败');
                }
            } catch (err) {
                console.error('添加班委会成员错误:', err);
                alert('网络错误，添加失败');
            }
        }

        async function deleteCommitteeMember(id) {
            if (!confirm('确定要删除该班委会成员吗？')) return;

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/committee/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('删除班委会成员失败');
                
                const data = await response.json();
                if (data.success) {
                    loadCommitteeMembers(); // 刷新列表
                    alert('删除成功');
                } else {
                    alert(data.error || '删除失败');
                }
            } catch (err) {
                console.error('删除班委会成员错误:', err);
                alert('网络错误，删除失败');
            }
        }

        // 6. 值日安排管理
        function initScheduleEvents() {
            document.getElementById('filter-schedules-btn').addEventListener('click', loadSchedules);
        }

        async function loadSchedules() {
            const startDate = document.getElementById('schedule-start-date').value;
            const endDate = document.getElementById('schedule-end-date').value;
            const status = document.getElementById('schedule-status-filter').value;
            const tableBody = document.getElementById('schedules-table-body');
            
            try {
                let url = `${CONFIG.API_BASE_URL}/schedules`;
                const params = new URLSearchParams();
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (status) params.append('status', status);
                if (params.toString()) url += `?${params.toString()}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('获取值日安排失败');
                
                const schedules = await response.json();
                
                if (schedules.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">暂无值日数据</td></tr>';
                    return;
                }
                
                let html = '';
                schedules.forEach(schedule => {
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">${schedule.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${schedule.personnel}</td>
                            <td class="px-6 py-4">${schedule.task || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    ${schedule.status === '已完成' ? 'bg-green-100 text-green-800' : 
                                      schedule.status === '进行中' ? 'bg-yellow-100 text-yellow-800' : 
                                      'bg-red-100 text-red-800'}">
                                    ${schedule.status}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = html;
            } catch (err) {
                console.error('加载值日安排错误:', err);
                tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">加载失败</td></tr>';
            }
        }

        // 7. 班级活动管理
        function initActivityEvents() {
            document.getElementById('filter-activities-btn').addEventListener('click', loadActivities);
        }

        async function loadActivities() {
            const startDate = document.getElementById('activity-start-date').value;
            const endDate = document.getElementById('activity-end-date').value;
            const type = document.getElementById('activity-type-filter').value;
            const tableBody = document.getElementById('activities-table-body');
            
            try {
                let url = `${CONFIG.API_BASE_URL}/activities`;
                const params = new URLSearchParams();
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (type) params.append('type', type);
                if (params.toString()) url += `?${params.toString()}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('获取班级活动失败');
                
                const activities = await response.json();
                
                if (activities.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">暂无活动数据</td></tr>';
                    return;
                }
                
                let html = '';
                activities.forEach(activity => {
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">${activity.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${activity.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                                    ${activity.type}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">${activity.creator || '-'}</td>
                            <td class="px-6 py-4">${activity.description || '-'}</td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = html;
            } catch (err) {
                console.error('加载班级活动错误:', err);
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">加载失败</td></tr>';
            }
        }

        // 8. 留言簿管理
        function initMessageEvents() {
            document.getElementById('send-message-btn').addEventListener('click', sendMessage);
            document.getElementById('new-message').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        }

        async function loadMessages() {
            const messagesList = document.getElementById('messages-list');
            
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/messages`);
                if (!response.ok) throw new Error('获取留言失败');
                
                const messages = await response.json();
                
                if (messages.length === 0) {
                    messagesList.innerHTML = '<p class="text-center text-gray-500 py-6">暂无留言</p>';
                    return;
                }
                
                let html = '';
                messages.forEach(msg => {
                    html += `
                        <div class="message-item">
                            <div class="flex justify-between">
                                <span class="font-medium">${msg.username}</span>
                                <span class="text-sm text-gray-500">${formatDateTime(msg.created_at)}</span>
                            </div>
                            <div class="mt-1 text-gray-700">${msg.content}</div>
                        </div>
                    `;
                });
                messagesList.innerHTML = html;
            } catch (err) {
                console.error('加载留言错误:', err);
                messagesList.innerHTML = '<p class="text-center text-red-500 py-6">加载失败</p>';
            }
        }

        async function sendMessage() {
            const content = document.getElementById('new-message').value.trim();
            if (!content) return;
            
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, userId: currentUser.id })
                });

                if (!response.ok) throw new Error('发送留言失败');
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('new-message').value = '';
                    loadMessages(); // 刷新留言列表
                } else {
                    alert(data.error || '发送失败');
                }
            } catch (err) {
                console.error('发送留言错误:', err);
                alert('网络错误，发送失败');
            }
        }

        // 9. 实时聊天
        function initChatEvents() {
            document.getElementById('send-chat-btn').addEventListener('click', sendChatMessage);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
        }

        function initWebSocket() {
            if (ws) return;
            
            // 连接WebSocket服务器
            ws = new WebSocket(CONFIG.WS_BASE_URL);
            
            // 连接成功
            ws.onopen = () => {
                console.log('WebSocket连接成功');
                document.getElementById('chat-messages').innerHTML = '<p class="text-center text-green-500">已连接到聊天服务器</p>';
                // 发送登录信息
                ws.send(JSON.stringify({
                    type: 'login',
                    userId: currentUser.id,
                    username: currentUser.username
                }));
            };
            
            // 接收消息
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (err) {
                    console.error('解析WebSocket消息错误:', err);
                }
            };
            
            // 连接关闭
            ws.onclose = () => {
                console.log('WebSocket连接关闭');
                document.getElementById('chat-messages').innerHTML += '<p class="text-center text-red-500">已断开连接，正在尝试重连...</p>';
                ws = null;
                // 自动重连
                setTimeout(initWebSocket, 3000);
            };
            
            // 连接错误
            ws.onerror = (err) => {
                console.error('WebSocket错误:', err);
                document.getElementById('chat-messages').innerHTML += '<p class="text-center text-red-500">连接错误</p>';
            };
        }

        function handleWebSocketMessage(data) {
            const chatMessages = document.getElementById('chat-messages');
            const onlineUsersList = document.getElementById('online-users-list');
            
            switch (data.type) {
                case 'userList':
                    // 更新在线用户列表
                    if (data.users.length === 0) {
                        onlineUsersList.innerHTML = '<p class="text-sm text-gray-500">暂无在线用户</p>';
                    } else {
                        let html = '';
                        data.users.forEach(user => {
                            html += `<div class="flex items-center">
                                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                <span>${user.username}</span>
                            </div>`;
                        });
                        onlineUsersList.innerHTML = html;
                    }
                    break;
                    
                case 'message':
                    // 添加聊天消息
                    const messageHtml = `
                        <div class="flex ${data.username === currentUser.username ? 'justify-end' : 'justify-start'}">
                            <div class="${data.username === currentUser.username ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'} px-4 py-2 rounded-lg max-w-xs">
                                <div class="text-xs ${data.username === currentUser.username ? 'text-blue-100' : 'text-gray-500'}">
                                    ${data.username === currentUser.username ? '我' : data.username} ${data.time}
                                </div>
                                <div>${data.content}</div>
                            </div>
                        </div>
                    `;
                    chatMessages.innerHTML += messageHtml;
                    // 滚动到底部
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    break;
            }
        }

        function sendChatMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('未连接到聊天服务器');
                return;
            }
            
            const content = document.getElementById('chat-input').value.trim();
            if (!content) return;
            
            // 发送消息
            ws.send(JSON.stringify({
                type: 'message',
                username: currentUser.username,
                content: content
            }));
            
            // 清空输入框
            document.getElementById('chat-input').value = '';
        }

        // 工具函数
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // 暴露全局函数（用于HTML中直接调用）
        window.deleteClassMember = deleteClassMember;
        window.deleteCommitteeMember = deleteCommitteeMember;
    </script>
</body>
</html>
