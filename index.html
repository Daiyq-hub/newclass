<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班级管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        .sidebar-link { 
            @apply flex items-center px-4 py-3 text-gray-200 hover:bg-blue-700 transition-colors duration-200 rounded-md; 
        }
        .sidebar-link.active { @apply bg-blue-700; }
        .sidebar-category { @apply flex items-center justify-between px-4 py-3 text-white font-medium cursor-pointer; }
        .content-card { @apply bg-white rounded-lg shadow-md p-6 mb-6; }
        .page-content { @apply p-6; }
        .nav-item { @apply cursor-pointer; }
        .message-item { @apply border-l-4 border-purple-500 pl-4 py-2 mb-3; }
        .stat-card { @apply bg-white rounded-lg shadow p-4 border-l-4; }
        .transition-height { transition: max-height 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex overflow-hidden">
    <!-- 登录页面 -->
    <div id="login-page" class="w-full min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 sm:p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">班级管理系统</h2>
                    <p class="mt-2 text-gray-500">请登录您的账号</p>
                </div>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">用户名</label>
                        <input type="text" id="username" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">密码</label>
                        <input type="password" id="password" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="user-role" class="block text-sm font-medium text-gray-700">角色</label>
                        <select id="user-role" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="admin">管理员</option>
                            <option value="teacher">教师</option>
                            <option value="student">学生</option>
                        </select>
                    </div>
                    <button type="submit" 
                        class="w-full py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        登录
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div id="app" class="hidden flex h-screen w-full">
        <!-- 侧边栏 -->
        <aside class="bg-blue-800 text-white w-64 flex-shrink-0 overflow-y-auto">
            <div class="p-6 border-b border-blue-700">
                <h1 class="text-xl font-bold">班级管理系统</h1>
            </div>
            
            <!-- 主导航 -->
            <nav class="px-2 py-4">
                <!-- 系统概览 -->
                <div class="mb-2">
                    <div class="sidebar-category" data-category="overview">
                        <span><i class="fa fa-tachometer mr-2"></i>系统概览</span>
                        <i class="fa fa-chevron-down text-xs transition-transform duration-200"></i>
                    </div>
                    <div class="category-content pl-4 pr-2 overflow-hidden max-h-0 transition-height">
                        <a href="#" data-page="dashboard" class="sidebar-link nav-item active block">
                            仪表盘
                        </a>
                    </div>
                </div>

                <!-- 班级管理 -->
                <div class="mb-2">
                    <div class="sidebar-category" data-category="class">
                        <span><i class="fa fa-users mr-2"></i>班级管理</span>
                        <i class="fa fa-chevron-down text-xs transition-transform duration-200"></i>
                    </div>
                    <div class="category-content pl-4 pr-2 overflow-hidden max-h-0 transition-height">
                        <a href="#" data-page="class-members" class="sidebar-link nav-item block">
                            班级成员
                        </a>
                        <a href="#" data-page="committee" class="sidebar-link nav-item block">
                            班委会
                        </a>
                        <a href="#" data-page="schedules" class="sidebar-link nav-item block">
                            值日安排
                        </a>
                        <a href="#" data-page="activities" class="sidebar-link nav-item block">
                            班级活动
                        </a>
                    </div>
                </div>

                <!-- 沟通交流 -->
                <div class="mb-2">
                    <div class="sidebar-category" data-category="communication">
                        <span><i class="fa fa-comments mr-2"></i>沟通交流</span>
                        <i class="fa fa-chevron-down text-xs transition-transform duration-200"></i>
                    </div>
                    <div class="category-content pl-4 pr-2 overflow-hidden max-h-0 transition-height">
                        <a href="#" data-page="messages" class="sidebar-link nav-item block">
                            留言簿
                        </a>
                        <a href="#" data-page="chat" class="sidebar-link nav-item block">
                            实时聊天
                        </a>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- 主内容区 -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- 顶部导航栏 -->
            <header class="bg-white shadow-sm px-6 py-3 flex justify-between items-center">
                <h2 id="page-title" class="text-lg font-semibold">仪表盘</h2>
                <div class="flex items-center">
                    <span id="user-info" class="mr-4"></span>
                    <button id="logout-btn" class="text-gray-600 hover:text-gray-900 transition-colors">
                        <i class="fa fa-sign-out mr-1"></i>退出
                    </button>
                </div>
            </header>

            <!-- 页面内容 -->
            <main class="flex-1 overflow-y-auto bg-gray-100 p-4">
                <!-- 仪表盘页面 -->
                <div id="dashboard-page" class="page-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="stat-card border-blue-500">
                            <div class="text-sm text-gray-500">班级总人数</div>
                            <div class="text-xl font-bold mt-1" id="stat-total-members">0</div>
                        </div>
                        <div class="stat-card border-yellow-500">
                            <div class="text-sm text-gray-500">本月活动</div>
                            <div class="text-xl font-bold mt-1" id="stat-monthly-activities">0</div>
                        </div>
                        <div class="stat-card border-purple-500">
                            <div class="text-sm text-gray-500">最新留言</div>
                            <div class="text-xl font-bold mt-1" id="stat-recent-messages">0</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="content-card">
                            <h3 class="text-lg font-semibold mb-4">本月班级活动统计</h3>
                            <div id="activities-chart" class="h-64 flex items-center justify-center">
                                <p class="text-gray-500">加载统计数据中...</p>
                            </div>
                        </div>
                        <div class="content-card">
                            <h3 class="text-lg font-semibold mb-4">值日完成情况</h3>
                            <div id="schedules-chart" class="h-64 flex items-center justify-center">
                                <p class="text-gray-500">加载统计数据中...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 班级成员页面 -->
                <div id="class-members-page" class="page-content hidden">
                    <div class="content-card">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">班级成员管理</h3>
                            <button id="add-member-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors">
                                <i class="fa fa-plus mr-1"></i>添加成员
                            </button>
                        </div>

                        <div class="mb-4 flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <input type="text" id="member-search" placeholder="搜索姓名或学号..."
                                    class="w-full px-4 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="w-full md:w-40">
                                <select id="member-role-filter" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                                    <option value="">所有角色</option>
                                    <option value="teacher">教师</option>
                                    <option value="student">学生</option>
                                </select>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学号/工号</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">角色</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">联系电话</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="members-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- 成员数据将通过JS动态加载 -->
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">加载成员数据中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 班委会页面 -->
                <div id="committee-page" class="page-content hidden">
                    <div class="content-card">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">班委会管理</h3>
                            <button id="add-committee-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors">
                                <i class="fa fa-plus mr-1"></i>添加成员
                            </button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学号</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">职务</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">职责</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="committee-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- 班委会数据将通过JS动态加载 -->
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">加载班委会数据中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 值日安排页面 -->
                <div id="schedules-page" class="page-content hidden">
                    <div class="content-card">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                            <h3 class="text-lg font-semibold">值日安排管理</h3>
                            <div class="flex gap-4 w-full md:w-auto">
                                <div class="flex gap-2">
                                    <input type="date" id="schedule-start-date" class="px-4 py-2 border border-gray-300 rounded-md">
                                    <span class="flex items-center">至</span>
                                    <input type="date" id="schedule-end-date" class="px-4 py-2 border border-gray-300 rounded-md">
                                </div>
                                <select id="schedule-status-filter" class="px-4 py-2 border border-gray-300 rounded-md">
                                    <option value="">所有状态</option>
                                    <option value="未开始">未开始</option>
                                    <option value="进行中">进行中</option>
                                    <option value="已完成">已完成</option>
                                </select>
                                <button id="filter-schedules-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                                    <i class="fa fa-filter mr-1"></i>筛选
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">值日人员</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">任务描述</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                    </tr>
                                </thead>
                                <tbody id="schedules-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- 值日数据将通过JS动态加载 -->
                                    <tr>
                                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">加载值日数据中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 班级活动页面 -->
                <div id="activities-page" class="page-content hidden">
                    <div class="content-card">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                            <h3 class="text-lg font-semibold">班级活动管理</h3>
                            <div class="flex gap-4 w-full md:w-auto">
                                <div class="flex gap-2">
                                    <input type="date" id="activity-start-date" class="px-4 py-2 border border-gray-300 rounded-md">
                                    <span class="flex items-center">至</span>
                                    <input type="date" id="activity-end-date" class="px-4 py-2 border border-gray-300 rounded-md">
                                </div>
                                <select id="activity-type-filter" class="px-4 py-2 border border-gray-300 rounded-md">
                                    <option value="">所有类型</option>
                                    <option value="会议">会议</option>
                                    <option value="比赛">比赛</option>
                                    <option value="志愿活动">志愿活动</option>
                                    <option value="其他">其他</option>
                                </select>
                                <button id="filter-activities-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                                    <i class="fa fa-filter mr-1"></i>筛选
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">活动名称</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">负责人</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">详情</th>
                                    </tr>
                                </thead>
                                <tbody id="activities-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- 活动数据将通过JS动态加载 -->
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">加载活动数据中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 留言簿页面 -->
                <div id="messages-page" class="page-content hidden">
                    <div class="content-card">
                        <h3 class="text-lg font-semibold mb-6">班级留言簿</h3>
                        
                        <div class="mb-6">
                            <textarea id="new-message" rows="3" placeholder="输入留言内容..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"></textarea>
                            <div class="mt-2 flex justify-end">
                                <button id="send-message-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                                    <i class="fa fa-paper-plane mr-1"></i>发送留言
                                </button>
                            </div>
                        </div>

                        <div id="messages-list">
                            <!-- 留言数据将通过JS动态加载 -->
                            <p class="text-center text-gray-500 py-6">加载留言数据中...</p>
                        </div>
                    </div>
                </div>

                <!-- 实时聊天页面 -->
                <div id="chat-page" class="page-content hidden">
                    <div class="content-card h-[calc(100vh-12rem)] flex flex-col">
                        <div class="flex-1 flex">
                            <!-- 在线用户列表 -->
                            <div class="w-64 border-r border-gray-200 p-4">
                                <h4 class="font-medium mb-3">在线用户</h4>
                                <div id="online-users-list" class="space-y-2">
                                    <!-- 在线用户将通过WebSocket动态加载 -->
                                    <p class="text-sm text-gray-500">加载在线用户中...</p>
                                </div>
                            </div>
                            
                            <!-- 聊天内容 -->
                            <div class="flex-1 flex flex-col">
                                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                                    <!-- 聊天消息将通过WebSocket动态加载 -->
                                    <p class="text-center text-gray-500 py-6">等待连接...</p>
                                </div>
                                
                                <!-- 发送消息框 -->
                                <div class="border-t border-gray-200 p-4">
                                    <div class="flex gap-2">
                                        <input type="text" id="chat-input" placeholder="输入消息..."
                                            class="flex-1 px-4 py-2 border border-gray-300 rounded-md">
                                        <button id="send-chat-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                                            <i class="fa fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 添加成员模态框 -->
    <div id="add-member-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md p-6">
            <h3 class="text-lg font-semibold mb-4">添加班级成员</h3>
            <form id="add-member-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">学号/工号</label>
                    <input type="text" id="member-id" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                    <input type="text" id="member-name" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">角色</label>
                    <select id="member-role" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                        <option value="teacher">教师</option>
                        <option value="student">学生</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">联系电话</label>
                    <input type="text" id="member-phone"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                    <input type="email" id="member-email"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-add-member" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 配置与常量定义
        const CONFIG = {
            API_BASE_URL: 'http://101.35.129.174:3000/api',
            WS_BASE_URL: 'ws://101.35.129.174:3000',
            DEFAULT_EMPTY_TEXT: '暂无数据',
            LOADING_TEXT: '加载中...',
            ERROR_TEXT: '加载失败，请重试'
        };

        // 接口路径常量
        const API_PATHS = {
            login: '/login',
            classMembers: '/class-members',
            committee: '/committee',
            activities: '/activities',
            schedules: '/schedules',
            messages: '/messages',
            activitiesStats: '/activities/stats',
            schedulesStats: '/schedules/stats'
        };

        // 全局变量
        let currentUser = null;
        let ws = null;

        // 通用HTTP请求工具
        const Http = {
            async get(url, params = {}) {
                // 处理查询参数
                const queryParams = new URLSearchParams();
                Object.entries(params).forEach(([key, value]) => {
                    if (value) queryParams.append(key, value);
                });
                
                const fullUrl = queryParams.toString() 
                    ? `${url}?${queryParams.toString()}` 
                    : url;
                    
                try {
                    const response = await fetch(fullUrl);
                    if (!response.ok) throw new Error('请求失败');
                    return await response.json();
                } catch (err) {
                    console.error('GET请求错误:', err);
                    throw err;
                }
            },
            
            async post(url, data = {}) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) throw new Error('请求失败');
                    return await response.json();
                } catch (err) {
                    console.error('POST请求错误:', err);
                    throw err;
                }
            },
            
            async delete(url) {
                try {
                    const response = await fetch(url, { method: 'DELETE' });
                    if (!response.ok) throw new Error('请求失败');
                    return await response.json();
                } catch (err) {
                    console.error('DELETE请求错误:', err);
                    throw err;
                }
            }
        };

        // 表格渲染工具
        const TableRenderer = {
            // 渲染加载状态
            renderLoading(containerId, colSpan = 5) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `<tr><td colspan="${colSpan}" class="px-6 py-4 text-center text-gray-500">${CONFIG.LOADING_TEXT}</td></tr>`;
                }
            },
            
            // 渲染空状态
            renderEmpty(containerId, colSpan = 5, text = CONFIG.DEFAULT_EMPTY_TEXT) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `<tr><td colspan="${colSpan}" class="px-6 py-4 text-center text-gray-500">${text}</td></tr>`;
                }
            },
            
            // 渲染错误状态
            renderError(containerId, colSpan = 5) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `<tr><td colspan="${colSpan}" class="px-6 py-4 text-center text-red-500">${CONFIG.ERROR_TEXT}</td></tr>`;
                }
            },
            
            // 渲染表格数据
            renderData(containerId, data, renderRow) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                if (data.length === 0) {
                    this.renderEmpty(containerId);
                    return;
                }
                
                container.innerHTML = data.map(renderRow).join('');
            }
        };

        // WebSocket模块
        const ChatSocket = {
            socket: null,
            
            init() {
                if (this.socket && this.socket.readyState === WebSocket.OPEN) return;
                
                this.socket = new WebSocket(CONFIG.WS_BASE_URL);
                
                this.socket.onopen = () => {
                    console.log('WebSocket连接成功');
                    this.sendLoginInfo();
                };
                
                this.socket.onmessage = (event) => {
                    this.handleMessage(event.data);
                };
                
                this.socket.onerror = (err) => {
                    console.error('WebSocket错误:', err);
                    this.showError('连接错误，请重试');
                };
                
                this.socket.onclose = () => {
                    console.log('WebSocket连接关闭');
                    this.updateOnlineUsers('已断开连接');
                };
            },
            
            sendLoginInfo() {
                if (currentUser && this.socket.readyState === WebSocket.OPEN) {
                    this.socket.send(JSON.stringify({
                        type: 'login',
                        userId: currentUser.id,
                        username: currentUser.username
                    }));
                }
            },
            
            sendMessage(content) {
                if (!content || !this.socket || this.socket.readyState !== WebSocket.OPEN) return;
                
                this.socket.send(JSON.stringify({
                    type: 'message',
                    username: currentUser.username,
                    content: content
                }));
            },
            
            handleMessage(data) {
                try {
                    const message = JSON.parse(data);
                    switch (message.type) {
                        case 'userList':
                            this.updateOnlineUsers(message.users);
                            break;
                        case 'message':
                            this.appendChatMessage(message);
                            break;
                        default:
                            console.log('未知消息类型:', message);
                    }
                } catch (err) {
                    console.error('处理WebSocket消息错误:', err);
                }
            },
            
            updateOnlineUsers(users) {
                const onlineUsersList = document.getElementById('online-users-list');
                if (!onlineUsersList) return;
                
                if (typeof users === 'string') {
                    onlineUsersList.innerHTML = `<p class="text-sm text-gray-500">${users}</p>`;
                    return;
                }
                
                onlineUsersList.innerHTML = users.map(user => `
                    <p class="text-sm">${user.username}</p>
                `).join('');
            },
            
            appendChatMessage(message) {
                const chatMessages = document.getElementById('chat-messages');
                if (!chatMessages) return;
                
                const isCurrentUser = message.username === currentUser.username;
                const messageHtml = `
                    <div class="flex ${isCurrentUser ? 'justify-end' : 'justify-start'}">
                        <div class="${isCurrentUser ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'} px-4 py-2 rounded-md max-w-xs">
                            <div class="font-medium text-sm">${message.username}</div>
                            <div class="mt-1">${message.content}</div>
                        </div>
                    </div>
                `;
                
                chatMessages.innerHTML += messageHtml;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            },
            
            showError(message) {
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages) {
                    chatMessages.innerHTML = `<p class="text-center text-red-500 py-6">${message}</p>`;
                }
            }
        };

        // 确保DOM完全加载后执行所有脚本
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化所有功能
            initSidebar();
            initNavigation();
            initLoginForm();
            initLogout();
            initFeatureEvents();

            // 检查本地存储中的登录状态
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
                loadDashboardData();
            }
        });

        // 初始化侧边栏折叠/展开
        function initSidebar() {
            const categories = document.querySelectorAll('.sidebar-category');
            
            categories.forEach(category => {
                category.addEventListener('click', () => {
                    const content = category.nextElementSibling;
                    const icon = category.querySelector('.fa-chevron-down');
                    
                    // 切换内容高度
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        content.style.maxHeight = content.scrollHeight + 'px';
                        icon.style.transform = 'rotate(180deg)';
                    }
                });
            });

            // 默认展开第一个分类
            const firstCategory = document.querySelector('.sidebar-category');
            if (firstCategory) {
                firstCategory.click();
            }
        }

        // 初始化导航切换
        function initNavigation() {
            const navLinks = document.querySelectorAll('.sidebar-link.nav-item');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // 更新活跃状态
                    document.querySelectorAll('.sidebar-link.nav-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    link.classList.add('active');
                    
                    // 切换页面
                    const targetPage = link.getAttribute('data-page');
                    document.querySelectorAll('.page-content').forEach(page => {
                        page.classList.add('hidden');
                    });
                    const targetElement = document.getElementById(`${targetPage}-page`);
                    if (targetElement) {
                        targetElement.classList.remove('hidden');
                    }
                    
                    // 更新页面标题
                    const pageTitle = link.textContent.trim();
                    const titleElement = document.getElementById('page-title');
                    if (titleElement) {
                        titleElement.textContent = pageTitle;
                    }

                    // 加载对应页面数据
                    if (targetPage === 'class-members') {
                        loadClassMembers();
                    } else if (targetPage === 'committee') {
                        loadCommitteeMembers();
                    } else if (targetPage === 'schedules') {
                        loadSchedules();
                    } else if (targetPage === 'activities') {
                        loadActivities();
                    } else if (targetPage === 'messages') {
                        loadMessages();
                    } else if (targetPage === 'chat') {
                        ChatSocket.init();
                    }
                });
            });
        }

        // 初始化功能按钮事件
        function initFeatureEvents() {
            // 班级成员相关
            initMemberEvents();
            
            // 值日安排筛选
            const filterSchedulesBtn = document.getElementById('filter-schedules-btn');
            if (filterSchedulesBtn) {
                filterSchedulesBtn.addEventListener('click', loadSchedules);
            }

            // 班级活动筛选
            const filterActivitiesBtn = document.getElementById('filter-activities-btn');
            if (filterActivitiesBtn) {
                filterActivitiesBtn.addEventListener('click', loadActivities);
            }

            // 发送留言
            const sendMessageBtn = document.getElementById('send-message-btn');
            if (sendMessageBtn) {
                sendMessageBtn.addEventListener('click', sendMessage);
            }

            // 发送聊天消息
            const sendChatBtn = document.getElementById('send-chat-btn');
            if (sendChatBtn) {
                sendChatBtn.addEventListener('click', sendChatMessage);
            }
            
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') sendChatMessage();
                });
            }
        }

        // 成员相关事件
        function initMemberEvents() {
            const addMemberBtn = document.getElementById('add-member-btn');
            if (addMemberBtn) {
                addMemberBtn.addEventListener('click', () => openModal('add-member-modal'));
            }
            
            const cancelAddMember = document.getElementById('cancel-add-member');
            if (cancelAddMember) {
                cancelAddMember.addEventListener('click', () => closeModal('add-member-modal'));
            }
            
            const addMemberForm = document.getElementById('add-member-form');
            if (addMemberForm) {
                addMemberForm.addEventListener('submit', handleAddMember);
            }
            
            // 搜索和筛选
            const memberSearch = document.getElementById('member-search');
            if (memberSearch) {
                memberSearch.addEventListener('input', debounce(loadClassMembers, 300));
            }
            
            const memberRoleFilter = document.getElementById('member-role-filter');
            if (memberRoleFilter) {
                memberRoleFilter.addEventListener('change', loadClassMembers);
            }
        }

        // 初始化登录表单
        function initLoginForm() {
            const form = document.getElementById('login-form');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    const role = document.getElementById('user-role').value;
                    
                    try {
                        const response = await Http.post(`${CONFIG.API_BASE_URL}${API_PATHS.login}`, { 
                            username, 
                            password, 
                            role 
                        });
                        
                        if (response.success) {
                            currentUser = response.user;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            showApp();
                            loadDashboardData();
                        } else {
                            alert(response.message || '登录失败');
                        }
                    } catch (err) {
                        console.error('登录错误:', err);
                        alert('登录失败，请重试');
                    }
                });
            }
        }

        // 初始化退出功能
        function initLogout() {
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('currentUser');
                    currentUser = null;
                    // 关闭WebSocket连接
                    if (ChatSocket.socket && ChatSocket.socket.readyState === WebSocket.OPEN) {
                        ChatSocket.socket.close();
                    }
                    showLoginPage();
                });
            }
        }

        // 显示应用界面
        function showApp() {
            const loginPage = document.getElementById('login-page');
            const app = document.getElementById('app');
            const userInfo = document.getElementById('user-info');
            const statCurrentUser = document.getElementById('stat-current-user');
            
            if (loginPage && app) {
                loginPage.classList.add('hidden');
                app.classList.remove('hidden');
                
                if (userInfo && currentUser) {
                    userInfo.textContent = `${currentUser.username} (${getRoleText(currentUser.role)})`;
                }
                
                if (statCurrentUser && currentUser) {
                    statCurrentUser.textContent = `${currentUser.username} (${getRoleText(currentUser.role)})`;
                }
            }
        }

        // 显示登录页面
        function showLoginPage() {
            const app = document.getElementById('app');
            const loginPage = document.getElementById('login-page');
            const loginForm = document.getElementById('login-form');
            
            if (app && loginPage) {
                app.classList.add('hidden');
                loginPage.classList.remove('hidden');
                
                if (loginForm) {
                    loginForm.reset();
                }
            }
        }

        // 转换角色文本
        function getRoleText(role) {
            const roleMap = {
                'admin': '管理员',
                'teacher': '教师',
                'student': '学生'
            };
            return roleMap[role] || role;
        }

        // 加载仪表盘数据
        async function loadDashboardData() {
            try {
                // 加载班级成员总数
                const membersData = await Http.get(`${CONFIG.API_BASE_URL}${API_PATHS.classMembers}`);
                const statTotalMembers = document.getElementById('stat-total-members');
                if (statTotalMembers) {
                    statTotalMembers.textContent = membersData.length;
                }

                // 加载本月活动数
                const today = new Date();
                const monthStart = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-01`;
                const activitiesData = await Http.get(`${CONFIG.API_BASE_URL}${API_PATHS.activities}`, {
                    startDate: monthStart
                });
                const statMonthlyActivities = document.getElementById('stat-monthly-activities');
                if (statMonthlyActivities) {
                    statMonthlyActivities.textContent = activitiesData.length;
                }

                // 加载最新留言数
                const messagesData = await Http.get(`${CONFIG.API_BASE_URL}${API_PATHS.messages}`);
                const statRecentMessages = document.getElementById('stat-recent-messages');
                if (statRecentMessages) {
                    statRecentMessages.textContent = messagesData.length;
                }

                // 加载活动统计图表
                loadActivitiesStats();

                // 加载值日统计图表
                loadSchedulesStats();
            } catch (err) {
                console.error('加载仪表盘数据错误:', err);
            }
        }

        // 加载班级成员列表
        async function loadClassMembers() {
            const searchInput = document.getElementById('member-search');
            const roleFilter = document.getElementById('member-role-filter');
            
            if (!searchInput || !roleFilter) return;
            
            const containerId = 'members-table-body';
            TableRenderer.renderLoading(containerId);
            
            try {
                const membersList = await Http.get(`${CONFIG.API_BASE_URL}${API_PATHS.classMembers}`, {
                    search: searchInput.value,
                    role: roleFilter.value
                });
                
                TableRenderer.renderData(containerId, membersList, member => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${member.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${member.name || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${getRoleText(member.role)}</td>
                        <td class="px-6 py-4">${member.phone || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button class="text-red-500 hover:text-red-700 transition-colors" 
                                onclick="deleteClassMember(${member.id})">
                                <i class="fa fa-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                `);
            } catch (err) {
                console.error('加载班级成员错误:', err);
                TableRenderer.renderError(containerId);
            }
        }

        // 删除班级成员
        async function deleteClassMember(memberId) {
            if (!confirm('确定要删除这个成员吗？')) return;
            
            try {
                const data = await Http.delete(`${CONFIG.API_BASE_URL}${API_PATHS.classMembers}/${memberId}`);
                
                if (data.success) {
                    loadClassMembers();
                    loadDashboardData();
                } else {
                    alert('删除失败: ' + (data.error || '未知错误'));
                }
            } catch (err) {
                console.error('删除成员错误:', err);
                alert('删除失败，请重试');
            }
        }

        // 处理添加成员
        async function handleAddMember(e) {
            e.preventDefault();
            
            const memberData = {
                id: document.getElementById('member-id').value,
                name: document.getElementById('member-name').value,
                role: document.getElementById('member-role').value,
                phone: document.getElementById('member-phone').value,
                email: document.getElementById('member-email').value
            };
            
            try {
                const data = await Http.post(`${CONFIG.API_BASE_URL}${API_PATHS.classMembers}`, memberData);
                
                if (data.success) {
                    closeModal('add-member-modal');
                    loadClassMembers(); // 重新加载成员列表
                    loadDashboardData(); // 更新仪表盘统计
                } else {
                    alert('添加失败: ' + (data.error || '未知错误'));
                }
            } catch (err) {
                console.error('添加成员错误:', err);
                alert('添加失败，请重试');
            }
        }

        // 加载班委会成员
        async function loadCommitteeMembers() {
            const containerId = 'committee-table-body';
            TableRenderer.renderLoading(containerId);
            
            try {
                const committeeMembers = await Http.get(`${CONFIG.API_BASE_URL}${API_PATHS.committee}`);
                
                TableRenderer.renderData(containerId, committeeMembers, member => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${member.student_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${member.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${member.position}</td>
                        <td class="px-6 py-4">${member.responsibilities || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button class="text-red-500 hover:text-red-700 transition-colors" 
                                onclick="deleteCommitteeMember(${member.id})">
                                <i class="fa fa-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                `);
            } catch (err) {
                console.error('加载班委会成员错误:', err);
                TableRenderer.renderError(containerId);
            }
        }

        // 删除班委会成员
        async function deleteCommitteeMember(id) {
            if (!confirm('确定要删除这个班委会成员吗？')) return;
            
            try {
                const data = await Http.delete(`${CONFIG.API_BASE_URL}${API_PATHS.committee}/${id}`);
                
                if (data.success) {
                    loadCommitteeMembers();
                } else {
                    alert('删除失败: ' + (data.error || '未知错误'));
                }
            } catch (err) {
                console.error('删除班委会成员错误:', err);
                alert('删除失败，请重试');
            }
        }

        // 加载值日安排
        async function loadSchedules() {
            const startDateInput = document.getElementById('schedule-start-date');
            const endDateInput = document.getElementById('schedule-end-date');
            const statusFilter = document.getElementById('schedule-status-filter');
            
            if (!startDateInput || !endDateInput || !statusFilter) return;
            
            const containerId = 'schedules-table-body';
            TableRenderer.renderLoading(containerId, 4);
            
            try {
                const schedules = await Http.get(`${CONFIG.API_BASE_URL}${API_PATHS.schedules}`, {
                    startDate: startDateInput.value,
                    endDate: endDateInput.value,
                    status: statusFilter.value
                });
                
                TableRenderer.renderData(containerId, schedules, schedule => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${schedule.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${schedule.personnel}</td>
                        <td class="px-6 py-4">${schedule.task}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 rounded text-xs ${getStatusClass(schedule.status)}">
                                ${schedule.status}
                            </span>
                        </td>
                    </tr>
                `, 4);
            } catch (err) {
                console.error('加载值日安排错误:', err);
                TableRenderer.renderError(containerId, 4);
            }
        }

        // 获取状态样式
        function getStatusClass(status) {
            const statusMap = {
                '未开始': 'bg-yellow-100 text-yellow-800',
                '进行中': 'bg-blue-100 text-blue-800',
                '已完成': 'bg-green-100 text-green-800'
            };
            return statusMap[status] || 'bg-gray-100 text-gray-800';
        }

        // 加载班级活动
        async function loadActivities() {
            const startDateInput = document.getElementById('activity-start-date');
            const endDateInput = document.getElementById('activity-end-date');
            const typeFilter = document.getElementById('activity-type-filter');
            
            if (!startDateInput || !endDateInput || !typeFilter) return;
            
            const containerId = 'activities-table-body';
            TableRenderer.renderLoading(containerId);
            
            try {
                const activities = await Http.get(`${CONFIG.API_BASE_URL}${API_PATHS.activities}`, {
                    startDate: startDateInput.value,
                    endDate: endDateInput.value,
                    type: typeFilter.value
                });
                
                TableRenderer.renderData(containerId, activities, activity => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${activity.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${activity.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${activity.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${activity.creator || '-'}</td>
                        <td class="px-6 py-4">${activity.description || '-'}</td>
                    </tr>
                `);
            } catch (err) {
                console.error('加载班级活动错误:', err);
                TableRenderer.renderError(containerId);
            }
        }

        // 加载留言
        async function loadMessages() {
            const containerId = 'messages-list';
            const container = document.getElementById(containerId);
            
            if (container) {
                container.innerHTML = `<p class="text-center text-gray-500 py-6">${CONFIG.LOADING_TEXT}</p>`;
            }
            
            try {
                const messages = await Http.get(`${CONFIG.API_BASE_URL}${API_PATHS.messages}`);
                
                if (container) {
                    if (messages.length === 0) {
                        container.innerHTML = `<p class="text-center text-gray-500 py-6">${CONFIG.DEFAULT_EMPTY_TEXT}</p>`;
                        return;
                    }
                    
                    container.innerHTML = messages.map(msg => `
                        <div class="message-item">
                            <div class="flex justify-between items-start">
                                <span class="font-medium">${msg.username}</span>
                                <span class="text-xs text-gray-500">${formatDate(msg.created_at)}</span>
                            </div>
                            <p class="mt-1 text-gray-700">${msg.content}</p>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('加载留言错误:', err);
                if (container) {
                    container.innerHTML = `<p class="text-center text-red-500 py-6">${CONFIG.ERROR_TEXT}</p>`;
                }
            }
        }

        // 发送留言
        async function sendMessage() {
            const contentInput = document.getElementById('new-message');
            if (!contentInput) return;
            
            const content = contentInput.value.trim();
            if (!content) return;
            
            try {
                const data = await Http.post(`${CONFIG.API_BASE_URL}${API_PATHS.messages}`, {
                    content, 
                    userId: currentUser.id
                });
                
                if (data.success) {
                    contentInput.value = '';
                    loadMessages();
                    loadDashboardData();
                } else {
                    alert('发送失败: ' + (data.error || '未知错误'));
                }
            } catch (err) {
                console.error('发送留言错误:', err);
                alert('发送失败，请重试');
            }
        }

        // 发送聊天消息
        function sendChatMessage() {
            const contentInput = document.getElementById('chat-input');
            if (!contentInput) return;
            
            const content = contentInput.value.trim();
            if (!content) return;
            
            ChatSocket.sendMessage(content);
            
            // 清空输入框
            contentInput.value = '';
        }

        // 加载活动统计图表
        async function loadActivitiesStats() {
            try {
                const stats = await Http.get(`${CONFIG.API_BASE_URL}${API_PATHS.activitiesStats}`);
                const chartContainer = document.getElementById('activities-chart');
                
                if (chartContainer) {
                    if (stats.length === 0) {
                        chartContainer.innerHTML = `<p class="text-gray-500">${CONFIG.DEFAULT_EMPTY_TEXT}</p>`;
                        return;
                    }
                    
                    // 简单的文本图表展示
                    let chartHtml = '<div class="space-y-2">';
                    stats.forEach(item => {
                        const barWidth = Math.min(item.count * 50, 400); // 最大宽度400px
                        chartHtml += `
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm">${item.month}</span>
                                    <span class="text-sm font-medium">${item.count}个活动</span>
                                </div>
                                <div class="h-4 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500" style="width: ${barWidth}px"></div>
                                </div>
                            </div>
                        `;
                    });
                    chartHtml += '</div>';
                    chartContainer.innerHTML = chartHtml;
                }
            } catch (err) {
                console.error('加载活动统计错误:', err);
                const chartContainer = document.getElementById('activities-chart');
                if (chartContainer) {
                    chartContainer.innerHTML = `<p class="text-red-500">${CONFIG.ERROR_TEXT}</p>`;
                }
            }
        }

        // 加载值日统计图表
        async function loadSchedulesStats() {
            try {
                const stats = await Http.get(`${CONFIG.API_BASE_URL}${API_PATHS.schedulesStats}`);
                const chartContainer = document.getElementById('schedules-chart');
                
                if (chartContainer) {
                    // 简单的文本图表展示
                    chartContainer.innerHTML = `
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-3xl font-bold text-green-500 mb-1">${stats.completedPercentage}%</div>
                                <div class="text-sm text-gray-600">已完成</div>
                                <div class="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-green-500" style="width: ${stats.completedPercentage}%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="text-3xl font-bold text-blue-500 mb-1">${stats.inProgressPercentage}%</div>
                                <div class="text-sm text-gray-600">进行中</div>
                                <div class="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500" style="width: ${stats.inProgressPercentage}%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="text-3xl font-bold text-yellow-500 mb-1">${stats.notStartedPercentage}%</div>
                                <div class="text-sm text-gray-600">未开始</div>
                                <div class="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-yellow-500" style="width: ${stats.notStartedPercentage}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('加载值日统计错误:', err);
                const chartContainer = document.getElementById('schedules-chart');
                if (chartContainer) {
                    chartContainer.innerHTML = `<p class="text-red-500">${CONFIG.ERROR_TEXT}</p>`;
                }
            }
        }

        // 通用模态框操作
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                const form = modal.querySelector('form');
                if (form) form.reset();
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('hidden');
        }

        // 工具函数：日期格式化
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 工具函数：防抖
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
    </script>
</body>
</html>
