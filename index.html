<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班级管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .sidebar-link { @apply flex items-center px-4 py-3 text-gray-200 hover:bg-blue-700 transition-colors duration-200 rounded-md; }
            .sidebar-link.active { @apply bg-blue-700; }
            .message-bubble { max-width: 80%; word-wrap: break-word; }
            .message-self { @apply bg-blue-500 text-white rounded-br-none ml-auto; }
            .message-other { @apply bg-gray-200 text-gray-800 rounded-bl-none mr-auto; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
    <!-- 登录页面 -->
    <div id="login-page" class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="bg-white rounded-lg shadow-xl overflow-hidden w-full max-w-md">
            <div class="p-6 sm:p-8">
                <div class="text-center mb-8">
                    <img src="https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/64bfd761e7284e2ca4149d44fd8884b1~tplv-a9rns2rl98-image.image?rcl=2025103114221315A5A8FEF816AE360D6D&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1764483800&x-signature=0kXWQWr8BDYT5ou7yQZm938g%2Fyw%3D" 
                         alt="班级管理系统" class="h-20 mx-auto mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">班级管理系统</h2>
                    <p class="text-gray-600 mt-1">请登录您的账户</p>
                </div>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-user"></i>
                            </span>
                            <input type="text" id="username" name="username" 
                                   class="pl-10 block w-full px-4 py-2 border border-gray-300 rounded-md" 
                                   placeholder="请输入用户名" required>
                        </div>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-lock"></i>
                            </span>
                            <input type="password" id="password" name="password" 
                                   class="pl-10 block w-full px-4 py-2 border border-gray-300 rounded-md" 
                                   placeholder="请输入密码" required>
                        </div>
                    </div>
                    <div>
                        <label for="user-role" class="block text-sm font-medium text-gray-700 mb-1">角色</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-users"></i>
                            </span>
                            <select id="user-role" name="userRole" 
                                    class="pl-10 block w-full px-4 py-2 border border-gray-300 rounded-md" 
                                    required>
                                <option value="">请选择角色</option>
                                <option value="admin">管理员</option>
                                <option value="teacher">教师</option>
                                <option value="student">学生</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <button type="submit" 
                                class="w-full flex justify-center py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            登录
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 主应用界面（默认隐藏） -->
    <div id="app" class="hidden flex h-screen overflow-hidden">
        <!-- 侧边栏导航 -->
        <aside class="bg-blue-800 text-white w-64 flex-shrink-0 hidden md:block">
            <div class="p-6">
                <h1 class="text-xl font-bold flex items-center">
                    <i class="fa fa-graduation-cap mr-2"></i>
                    班级管理系统
                </h1>
            </div>
            <nav class="px-2 py-4 space-y-1">
                <a href="#" data-page="dashboard" class="sidebar-link nav-link">
                    <i class="fa fa-dashboard w-5 mr-3"></i>
                    <span>仪表盘</span>
                </a>
                <a href="#" data-page="schedule" class="sidebar-link nav-link">
                    <i class="fa fa-calendar w-5 mr-3"></i>
                    <span>值日安排管理</span>
                </a>
                <a href="#" data-page="activities" class="sidebar-link nav-link">
                    <i class="fa fa-calendar-check-o w-5 mr-3"></i>
                    <span>班级活动记录</span>
                </a>
                <a href="#" data-page="messages" class="sidebar-link nav-link">
                    <i class="fa fa-comments w-5 mr-3"></i>
                    <span>班级留言簿</span>
                </a>
                <a href="#" data-page="socket" class="sidebar-link nav-link">
                    <i class="fa fa-exchange w-5 mr-3"></i>
                    <span>Socket通信</span>
                </a>
            </nav>
        </aside>

        <!-- 主内容区域 -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- 顶部导航栏 -->
            <header class="bg-white shadow-sm px-6 py-3 flex justify-between items-center">
                <button id="mobile-menu-btn" class="md:hidden text-gray-600">
                    <i class="fa fa-bars text-xl"></i>
                </button>
                <h2 id="page-title" class="text-xl font-semibold">仪表盘</h2>
                <div class="flex items-center">
                    <div class="relative ml-3">
                        <div class="flex items-center">
                            <span id="user-initial" class="h-8 w-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-medium">A</span>
                            <div class="ml-3 hidden md:block">
                                <div id="user-name-display" class="text-sm font-medium text-gray-700">管理员</div>
                                <div id="user-role-display" class="text-xs text-gray-500">admin</div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- 页面内容区域 -->
            <main class="flex-1 overflow-y-auto p-6 bg-gray-50">
                <!-- 仪表盘页面 -->
                <div id="dashboard-page" class="page-content">
                    <div class="bg-white rounded-lg shadow mb-6">
                        <div class="p-6">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">班级概览</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div class="bg-blue-50 p-6 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-blue-600">总人数</p>
                                            <h3 class="text-2xl font-bold text-gray-800 mt-1">45</h3>
                                        </div>
                                        <div class="h-12 w-12 bg-blue-100 rounded-full flex items-center justify-center">
                                            <i class="fa fa-users text-blue-600 text-xl"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-green-50 p-6 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-green-600">本月活动</p>
                                            <h3 class="text-2xl font-bold text-gray-800 mt-1" id="monthly-activities">0</h3>
                                        </div>
                                        <div class="h-12 w-12 bg-green-100 rounded-full flex items-center justify-center">
                                            <i class="fa fa-calendar-check-o text-green-600 text-xl"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-purple-50 p-6 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-purple-600">留言数</p>
                                            <h3 class="text-2xl font-bold text-gray-800 mt-1" id="total-messages">0</h3>
                                        </div>
                                        <div class="h-12 w-12 bg-purple-100 rounded-full flex items-center justify-center">
                                            <i class="fa fa-comments text-purple-600 text-xl"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 值日安排管理页面 -->
                <div id="schedule-page" class="page-content hidden">
                    <div class="bg-white rounded-lg shadow mb-6">
                        <div class="p-6">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">值日安排管理</h2>
                            
                            <!-- 时间段查询 -->
                            <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-medium text-gray-800 mb-3">按时间段查询</h3>
                                <div class="flex flex-col sm:flex-row gap-4">
                                    <div class="flex-1">
                                        <label for="schedule-start-date" class="block text-sm font-medium text-gray-700 mb-1">开始日期</label>
                                        <input type="date" id="schedule-start-date" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div class="flex-1">
                                        <label for="schedule-end-date" class="block text-sm font-medium text-gray-700 mb-1">结束日期</label>
                                        <input type="date" id="schedule-end-date" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div class="flex items-end">
                                        <button id="schedule-search-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                            <i class="fa fa-search mr-1"></i> 查询
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 统计结果 -->
                            <div id="schedule-stats" class="mb-6 bg-gray-50 p-4 rounded-lg hidden">
                                <h3 class="font-medium text-gray-800 mb-3">统计结果</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-white p-3 rounded border border-gray-200">
                                        <p class="text-sm text-gray-500">总天数</p>
                                        <p class="text-xl font-bold text-gray-800" id="total-days">0</p>
                                    </div>
                                    <div class="bg-white p-3 rounded border border-gray-200">
                                        <p class="text-sm text-gray-500">已完成</p>
                                        <p class="text-xl font-bold text-green-600" id="completed-days">0</p>
                                    </div>
                                    <div class="bg-white p-3 rounded border border-gray-200">
                                        <p class="text-sm text-gray-500">未完成</p>
                                        <p class="text-xl font-bold text-yellow-600" id="pending-days">0</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">星期</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">值日人员</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">职责</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                        </tr>
                                    </thead>
                                    <tbody id="schedule-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- 数据将通过JS从数据库加载 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 班级活动记录页面 -->
                <div id="activities-page" class="page-content hidden">
                    <div class="bg-white rounded-lg shadow mb-6">
                        <div class="p-6">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">班级活动记录</h2>
                            
                            <!-- 时间段查询 -->
                            <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-medium text-gray-800 mb-3">按时间段查询</h3>
                                <div class="flex flex-col sm:flex-row gap-4">
                                    <div class="flex-1">
                                        <label for="activity-start-date" class="block text-sm font-medium text-gray-700 mb-1">开始日期</label>
                                        <input type="date" id="activity-start-date" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div class="flex-1">
                                        <label for="activity-end-date" class="block text-sm font-medium text-gray-700 mb-1">结束日期</label>
                                        <input type="date" id="activity-end-date" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div class="flex items-end">
                                        <button id="activity-search-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                            <i class="fa fa-search mr-1"></i> 查询
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 统计结果 -->
                            <div id="activity-stats" class="mb-6 bg-gray-50 p-4 rounded-lg hidden">
                                <h3 class="font-medium text-gray-800 mb-3">统计结果</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-white p-3 rounded border border-gray-200">
                                        <p class="text-sm text-gray-500">活动总数</p>
                                        <p class="text-xl font-bold text-gray-800" id="total-activities">0</p>
                                    </div>
                                    <div class="bg-white p-3 rounded border border-gray-200">
                                        <p class="text-sm text-gray-500">体育活动</p>
                                        <p class="text-xl font-bold text-blue-600" id="sports-activities">0</p>
                                    </div>
                                    <div class="bg-white p-3 rounded border border-gray-200">
                                        <p class="text-sm text-gray-500">文艺活动</p>
                                        <p class="text-xl font-bold text-purple-600" id="cultural-activities">0</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="activities-list" class="space-y-6">
                                <!-- 数据将通过JS从数据库加载 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 班级留言簿页面 -->
                <div id="messages-page" class="page-content hidden">
                    <div class="bg-white rounded-lg shadow mb-6">
                        <div class="p-6">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">班级留言簿</h2>
                            <p class="text-gray-600 mb-6">所有班级成员都可以看到这里的留言</p>
                            
                            <div class="mb-6">
                                <textarea id="message-input" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="写下你的留言..."></textarea>
                                <div class="mt-3 flex justify-end">
                                    <button id="send-message-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                        发送留言
                                    </button>
                                </div>
                            </div>
                            
                            <div id="messages-list" class="space-y-4">
                                <!-- 数据将通过JS从数据库加载 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Socket通信页面 -->
                <div id="socket-page" class="page-content hidden">
                    <div class="bg-white rounded-lg shadow mb-6">
                        <div class="p-6">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Socket通信</h2>
                            <p class="text-gray-600 mb-6">与其他用户进行实时通信</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <!-- 连接设置 -->
                                <div class="md:col-span-1">
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h3 class="font-medium text-gray-800 mb-3">连接设置</h3>
                                        <div class="space-y-4">
                                            <div>
                                                <label for="socket-ip" class="block text-sm font-medium text-gray-700 mb-1">IP地址</label>
                                                <input type="text" id="socket-ip" value="localhost" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                                            </div>
                                            <div>
                                                <label for="socket-port" class="block text-sm font-medium text-gray-700 mb-1">端口号</label>
                                                <input type="number" id="socket-port" value="3000" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                                            </div>
                                            <div class="flex space-x-2">
                                                <button id="connect-btn" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                                    连接
                                                </button>
                                                <button id="disconnect-btn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700" disabled>
                                                    断开
                                                </button>
                                            </div>
                                            <div>
                                                <p id="connection-status" class="text-sm text-gray-500">未连接</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 聊天区域 -->
                                <div class="md:col-span-2">
                                    <div class="bg-gray-50 p-4 rounded-lg h-full flex flex-col">
                                        <h3 class="font-medium text-gray-800 mb-3">聊天窗口</h3>
                                        <div id="chat-messages" class="flex-1 overflow-y-auto mb-4 space-y-3 p-2 bg-white rounded border border-gray-200">
                                            <!-- 消息将在这里显示 -->
                                        </div>
                                        <div class="flex">
                                            <input type="text" id="chat-input" placeholder="输入消息..." class="flex-1 px-4 py-2 border border-gray-300 rounded-l-md">
                                            <button id="send-chat-btn" class="px-4 py-2 bg-blue-600 text-white rounded-r-md hover:bg-blue-700" disabled>
                                                发送
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // 全局变量
        let currentUser = null;
        let webSocket = null;
        const API_BASE_URL = 'http://localhost:3000/api';

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initLoginForm();
            initNavigation();
            initMessageBoard();
            initSocketCommunication();
            initDateRangeQueries();
            loadDashboardData();
        });

        // 初始化登录表单
        function initLoginForm() {
            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const role = document.getElementById('user-role').value;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password, role })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        currentUser = {
                            id: data.user.id,
                            name: data.user.username,
                            role: data.user.role,
                            initial: data.user.username.charAt(0).toUpperCase()
                        };
                        
                        // 更新用户信息显示
                        document.getElementById('user-initial').textContent = currentUser.initial;
                        document.getElementById('user-name-display').textContent = currentUser.name;
                        document.getElementById('user-role-display').textContent = currentUser.role;
                        
                        // 切换到应用界面
                        document.getElementById('login-page').classList.add('hidden');
                        document.getElementById('app').classList.remove('hidden');
                        
                        // 加载数据
                        loadMessages();
                        loadActivities();
                        loadSchedules();
                    } else {
                        alert('登录失败: ' + data.message);
                    }
                } catch (error) {
                    alert('登录失败，请检查服务器是否运行');
                }
            });
        }

        // 初始化导航
        function initNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pageTitle = document.getElementById('page-title');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 移除所有激活状态
                    navLinks.forEach(l => l.classList.remove('active'));
                    
                    // 添加当前激活状态
                    this.classList.add('active');
                    
                    // 获取目标页面
                    const targetPage = this.getAttribute('data-page');
                    
                    // 更新页面标题
                    pageTitle.textContent = this.querySelector('span').textContent;
                    
                    // 隐藏所有页面
                    document.querySelectorAll('.page-content').forEach(page => {
                        page.classList.add('hidden');
                    });
                    
                    // 显示目标页面
                    document.getElementById(`${targetPage}-page`).classList.remove('hidden');
                });
            });
            
            // 默认激活仪表盘
            document.querySelector('[data-page="dashboard"]').classList.add('active');
        }

        // 加载仪表盘数据
        async function loadDashboardData() {
            try {
                // 获取本月活动数
                const today = new Date();
                const startOfMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-01`;
                const endOfMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate()}`;
                
                const activitiesResponse = await fetch(`${API_BASE_URL}/activities?startDate=${startOfMonth}&endDate=${endOfMonth}`);
                const activities = await activitiesResponse.json();
                document.getElementById('monthly-activities').textContent = activities.length;
                
                // 获取总留言数
                const messagesResponse = await fetch(`${API_BASE_URL}/messages`);
                const messages = await messagesResponse.json();
                document.getElementById('total-messages').textContent = messages.length;
            } catch (error) {
                console.error('加载仪表盘数据失败:', error);
            }
        }

        // 初始化留言功能
        function initMessageBoard() {
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-message-btn');
            
            sendBtn.addEventListener('click', sendMessage);
            
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            async function sendMessage() {
                const content = messageInput.value.trim();
                if (content && currentUser) {
                    try {
                        await fetch(`${API_BASE_URL}/messages`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ content, userId: currentUser.id })
                        });
                        
                        // 重新加载留言列表
                        loadMessages();
                        messageInput.value = '';
                    } catch (error) {
                        alert('发送留言失败');
                    }
                }
            }
        }

        // 加载留言列表
        async function loadMessages() {
            try {
                const response = await fetch(`${API_BASE_URL}/messages`);
                const messages = await response.json();
                const messagesList = document.getElementById('messages-list');
                
                messagesList.innerHTML = '';
                messages.forEach(msg => {
                    const messageEl = document.createElement('div');
                    messageEl.className = 'border-l-4 border-purple-500 pl-4 py-2';
                    messageEl.innerHTML = `
                        <div class="flex justify-between">
                            <h4 class="font-medium text-gray-800">${msg.username}</h4>
                            <p class="text-sm text-gray-500">${new Date(msg.created_at).toLocaleString()}</p>
                        </div>
                        <p class="text-gray-600 mt-1">${msg.content}</p>
                    `;
                    messagesList.appendChild(messageEl);
                });
            } catch (error) {
                console.error('加载留言失败:', error);
            }
        }

        // 初始化Socket通信
        function initSocketCommunication() {
            const ipInput = document.getElementById('socket-ip');
            const portInput = document.getElementById('socket-port');
            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');
            const statusEl = document.getElementById('connection-status');
            const chatInput = document.getElementById('chat-input');
            const sendChatBtn = document.getElementById('send-chat-btn');
            const chatMessages = document.getElementById('chat-messages');
            
            connectBtn.addEventListener('click', function() {
                const ip = ipInput.value.trim();
                const port = portInput.value.trim();
                
                if (ip && port && !webSocket) {
                    try {
                        webSocket = new WebSocket(`ws://${ip}:${port}`);
                        
                        webSocket.onopen = function() {
                            statusEl.textContent = '已连接';
                            statusEl.className = 'text-sm text-green-600';
                            connectBtn.disabled = true;
                            disconnectBtn.disabled = false;
                            sendChatBtn.disabled = false;
                            
                            addChatMessage('系统消息', '连接成功，可以开始聊天了');
                        };
                        
                        webSocket.onmessage = function(event) {
                            try {
                                const data = JSON.parse(event.data);
                                addChatMessage(data.user, data.message, data.userId === currentUser.id);
                            } catch (e) {
                                addChatMessage('未知用户', event.data, false);
                            }
                        };
                        
                        webSocket.onclose = function() {
                            statusEl.textContent = '已断开连接';
                            statusEl.className = 'text-sm text-gray-500';
                            connectBtn.disabled = false;
                            disconnectBtn.disabled = true;
                            sendChatBtn.disabled = true;
                            webSocket = null;
                            
                            addChatMessage('系统消息', '连接已断开');
                        };
                        
                        webSocket.onerror = function(error) {
                            statusEl.textContent = '连接错误';
                            statusEl.className = 'text-sm text-red-600';
                        };
                    } catch (error) {
                        statusEl.textContent = '连接失败';
                        statusEl.className = 'text-sm text-red-600';
                    }
                }
            });
            
            disconnectBtn.addEventListener('click', function() {
                if (webSocket) {
                    webSocket.close();
                }
            });
            
            sendChatBtn.addEventListener('click', sendChatMessage);
            
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
            
            function sendChatMessage() {
                const message = chatInput.value.trim();
                if (message && webSocket && webSocket.readyState === WebSocket.OPEN && currentUser) {
                    const data = {
                        userId: currentUser.id,
                        user: currentUser.name,
                        message: message
                    };
                    
                    webSocket.send(JSON.stringify(data));
                    chatInput.value = '';
                }
            }
            
            function addChatMessage(user, message, isSelf = false) {
                const messageEl = document.createElement('div');
                messageEl.className = `flex ${isSelf ? 'justify-end' : 'justify-start'} mb-2`;
                
                const bubbleEl = document.createElement('div');
                bubbleEl.className = `message-bubble p-3 rounded-lg ${isSelf ? 'message-self' : 'message-other'}`;
                
                bubbleEl.innerHTML = `
                    <div class="font-medium text-xs mb-1">${user}</div>
                    <div>${message}</div>
                `;
                
                messageEl.appendChild(bubbleEl);
                chatMessages.appendChild(messageEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // 初始化时间段查询功能
        function initDateRangeQueries() {
            // 活动查询
            const activitySearchBtn = document.getElementById('activity-search-btn');
            activitySearchBtn.addEventListener('click', async function() {
                const startDate = document.getElementById('activity-start-date').value;
                const endDate = document.getElementById('activity-end-date').value;
                
                if (startDate && endDate) {
                    await loadActivities(startDate, endDate);
                }
            });
            
            // 值日查询
            const scheduleSearchBtn = document.getElementById('schedule-search-btn');
            scheduleSearchBtn.addEventListener('click', async function() {
                const startDate = document.getElementById('schedule-start-date').value;
                const endDate = document.getElementById('schedule-end-date').value;
                
                if (startDate && endDate) {
                    await loadSchedules(startDate, endDate);
                }
            });
        }

        // 加载活动列表（支持时间段筛选）
        async function loadActivities(startDate = '', endDate = '') {
            try {
                let url = `${API_BASE_URL}/activities`;
                if (startDate && endDate) {
                    url += `?startDate=${startDate}&endDate=${endDate}`;
                }
                
                const response = await fetch(url);
                const activities = await response.json();
                const activitiesList = document.getElementById('activities-list');
                
                activitiesList.innerHTML = '';
                if (activities.length === 0) {
                    activitiesList.innerHTML = '<p class="text-gray-500 text-center py-4">没有找到符合条件的活动</p>';
                    return;
                }
                
                activities.forEach(activity => {
                    const activityEl = document.createElement('div');
                    activityEl.className = 'border border-gray-200 rounded-lg p-4';
                    
                    let typeClass = '';
                    if (activity.type === '体育活动') {
                        typeClass = 'bg-blue-100 text-blue-800';
                    } else if (activity.type === '文艺活动') {
                        typeClass = 'bg-purple-100 text-purple-800';
                    } else {
                        typeClass = 'bg-green-100 text-green-800';
                    }
                    
                    activityEl.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-medium text-gray-800">${activity.name}</h3>
                                <p class="text-sm text-gray-500 mt-1">${activity.date}</p>
                            </div>
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${typeClass}">${activity.type}</span>
                        </div>
                        <p class="text-gray-600 mt-3">${activity.description}</p>
                    `;
                    
                    activitiesList.appendChild(activityEl);
                });
                
                // 显示统计结果
                showActivityStats(activities);
            } catch (error) {
                console.error('加载活动失败:', error);
            }
        }

        // 显示活动统计结果
        function showActivityStats(activities) {
            const statsEl = document.getElementById('activity-stats');
            const totalEl = document.getElementById('total-activities');
            const sportsEl = document.getElementById('sports-activities');
            const culturalEl = document.getElementById('cultural-activities');
            
            const total = activities.length;
            const sports = activities.filter(a => a.type === '体育活动').length;
            const cultural = activities.filter(a => a.type === '文艺活动').length;
            
            totalEl.textContent = total;
            sportsEl.textContent = sports;
            culturalEl.textContent = cultural;
            
            statsEl.classList.remove('hidden');
        }

        // 加载值日安排（支持时间段筛选）
        async function loadSchedules(startDate = '', endDate = '') {
            try {
                let url = `${API_BASE_URL}/schedules`;
                if (startDate && endDate) {
                    url += `?startDate=${startDate}&endDate=${endDate}`;
                }
                
                const response = await fetch(url);
                const schedules = await response.json();
                const tableBody = document.getElementById('schedule-table-body');
                
                tableBody.innerHTML = '';
                if (schedules.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">没有找到符合条件的值日安排</td></tr>';
                    return;
                }
                
                schedules.forEach(item => {
                    const row = document.createElement('tr');
                    
                    let statusClass = '';
                    if (item.status === '已完成') {
                        statusClass = 'bg-green-100 text-green-800';
                    } else if (item.status === '进行中') {
                        statusClass = 'bg-yellow-100 text-yellow-800';
                    } else {
                        statusClass = 'bg-gray-100 text-gray-800';
                    }
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${item.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${item.weekday}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${item.person}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${item.duty}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${item.status}</span>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // 显示统计结果
                showScheduleStats(schedules);
            } catch (error) {
                console.error('加载值日安排失败:', error);
            }
        }

        // 显示值日统计结果
        function showScheduleStats(schedules) {
            const statsEl = document.getElementById('schedule-stats');
            const totalEl = document.getElementById('total-days');
            const completedEl = document.getElementById('completed-days');
            const pendingEl = document.getElementById('pending-days');
            
            const total = schedules.length;
            const completed = schedules.filter(s => s.status === '已完成').length;
            const pending = total - completed;
            
            totalEl.textContent = total;
            completedEl.textContent = completed;
            pendingEl.textContent = pending;
            
            statsEl.classList.remove('hidden');
        }
    </script>
</body>
</html>
