<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班级管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        .sidebar-link { 
            @apply flex items-center px-4 py-3 text-gray-200 hover:bg-blue-700 transition-colors duration-200 rounded-md; 
        }
        .sidebar-link.active { @apply bg-blue-700; }
        .sidebar-category { @apply flex items-center justify-between px-4 py-3 text-white font-medium cursor-pointer; }
        .content-card { @apply bg-white rounded-lg shadow-md p-6 mb-6; }
        .page-content { @apply p-6; }
        .nav-item { @apply cursor-pointer; }
        .message-item { @apply border-l-4 border-purple-500 pl-4 py-2 mb-3; }
        .stat-card { @apply bg-white rounded-lg shadow p-4 border-l-4; }
        .transition-height { transition: max-height 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex overflow-hidden">
    <!-- 登录页面 -->
    <div id="login-page" class="w-full min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 sm:p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold">班级管理系统</h2>
                    <p class="text-gray-600 mt-1">请登录您的账户</p>
                </div>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                        <input type="text" id="username" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                        <input type="password" id="password" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">角色</label>
                        <select id="user-role" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="">请选择角色</option>
                            <option value="admin">管理员</option>
                            <option value="teacher">教师</option>
                            <option value="student">学生</option>
                        </select>
                    </div>
                    <button type="submit" 
                        class="w-full py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        登录
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div id="app" class="hidden flex h-screen w-full">
        <!-- 侧边栏 -->
        <aside class="bg-blue-800 text-white w-64 flex-shrink-0 overflow-y-auto">
            <div class="p-6 border-b border-blue-700">
                <h1 class="text-xl font-bold">班级管理系统</h1>
            </div>
            
            <!-- 主导航 -->
            <nav class="px-2 py-4">
                <!-- 系统概览 -->
                <div class="mb-2">
                    <div class="sidebar-category" data-category="overview">
                        <span><i class="fa fa-tachometer mr-2"></i>系统概览</span>
                        <i class="fa fa-chevron-down text-xs transition-transform duration-200"></i>
                    </div>
                    <div class="category-content pl-4 pr-2 overflow-hidden max-h-0 transition-height">
                        <a href="#" data-page="dashboard" class="sidebar-link nav-item active block">
                            <i class="fa fa-dashboard w-5 mr-3"></i>仪表盘
                        </a>
                    </div>
                </div>
                
                <!-- 人员管理 -->
                <div class="mb-2">
                    <div class="sidebar-category" data-category="personnel">
                        <span><i class="fa fa-users mr-2"></i>人员管理</span>
                        <i class="fa fa-chevron-down text-xs transition-transform duration-200"></i>
                    </div>
                    <div class="category-content pl-4 pr-2 overflow-hidden max-h-0 transition-height">
                        <a href="#" data-page="class-members" class="sidebar-link nav-item block">
                            <i class="fa fa-user-circle w-5 mr-3"></i>班级成员
                        </a>
                        <a href="#" data-page="committee" class="sidebar-link nav-item block">
                            <i class="fa fa-star w-5 mr-3"></i>班委会
                        </a>
                    </div>
                </div>
                
                <!-- 日常管理 -->
                <div class="mb-2">
                    <div class="sidebar-category" data-category="daily">
                        <span><i class="fa fa-calendar mr-2"></i>日常管理</span>
                        <i class="fa fa-chevron-down text-xs transition-transform duration-200"></i>
                    </div>
                    <div class="category-content pl-4 pr-2 overflow-hidden max-h-0 transition-height">
                        <a href="#" data-page="schedules" class="sidebar-link nav-item block">
                            <i class="fa fa-list-alt w-5 mr-3"></i>值日安排
                        </a>
                        <a href="#" data-page="activities" class="sidebar-link nav-item block">
                            <i class="fa fa-flag w-5 mr-3"></i>班级活动
                        </a>
                    </div>
                </div>
                
                <!-- 互动交流 -->
                <div class="mb-2">
                    <div class="sidebar-category" data-category="communication">
                        <span><i class="fa fa-comments mr-2"></i>互动交流</span>
                        <i class="fa fa-chevron-down text-xs transition-transform duration-200"></i>
                    </div>
                    <div class="category-content pl-4 pr-2 overflow-hidden max-h-0 transition-height">
                        <a href="#" data-page="messages" class="sidebar-link nav-item block">
                            <i class="fa fa-envelope w-5 mr-3"></i>留言簿
                        </a>
                        <a href="#" data-page="chat" class="sidebar-link nav-item block">
                            <i class="fa fa-comments-o w-5 mr-3"></i>实时聊天
                        </a>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- 主内容区 -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- 顶部导航栏 -->
            <header class="bg-white shadow-sm px-6 py-3 flex justify-between items-center">
                <h2 id="page-title" class="text-lg font-semibold text-gray-800">仪表盘</h2>
                <div class="flex items-center">
                    <span id="user-info" class="mr-4 text-gray-600"></span>
                    <button id="logout-btn" class="text-red-500 hover:text-red-700 transition-colors">
                        <i class="fa fa-sign-out mr-1"></i>退出
                    </button>
                </div>
            </header>

            <!-- 页面内容容器 -->
            <main class="flex-1 overflow-y-auto bg-gray-50 p-4">
                <!-- 仪表盘页面 -->
                <div id="dashboard-page" class="page-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="stat-card border-blue-500">
                            <div class="text-sm text-gray-500">当前用户</div>
                            <div class="text-xl font-bold mt-1" id="stat-current-user">-</div>
                        </div>
                        <div class="stat-card border-green-500">
                            <div class="text-sm text-gray-500">班级总人数</div>
                            <div class="text-xl font-bold mt-1" id="stat-total-members">0</div>
                        </div>
                        <div class="stat-card border-yellow-500">
                            <div class="text-sm text-gray-500">本月活动</div>
                            <div class="text-xl font-bold mt-1" id="stat-monthly-activities">0</div>
                        </div>
                        <div class="stat-card border-purple-500">
                            <div class="text-sm text-gray-500">最新留言</div>
                            <div class="text-xl font-bold mt-1" id="stat-recent-messages">0</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="content-card">
                            <h3 class="text-lg font-semibold mb-4">本月班级活动统计</h3>
                            <div id="activities-chart" class="h-64 flex items-center justify-center">
                                <p class="text-gray-500">加载统计数据中...</p>
                            </div>
                        </div>
                        <div class="content-card">
                            <h3 class="text-lg font-semibold mb-4">值日完成情况</h3>
                            <div id="schedules-chart" class="h-64 flex items-center justify-center">
                                <p class="text-gray-500">加载统计数据中...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 班级成员页面 -->
                <div id="class-members-page" class="page-content hidden">
                    <div class="content-card">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">班级成员管理</h3>
                            <button id="add-member-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors">
                                <i class="fa fa-plus mr-1"></i>添加成员
                            </button>
                        </div>

                        <div class="mb-4 flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <input type="text" id="member-search" placeholder="搜索姓名或学号..."
                                    class="w-full px-4 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="w-full md:w-40">
                                <select id="member-role-filter" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                                    <option value="">所有角色</option>
                                    <option value="teacher">教师</option>
                                    <option value="student">学生</option>
                                </select>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学号/工号</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">角色</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">联系电话</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="members-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- 成员数据将通过JS动态加载 -->
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">加载成员数据中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 班委会页面 -->
                <div id="committee-page" class="page-content hidden">
                    <div class="content-card">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">班委会管理</h3>
                            <button id="add-committee-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors">
                                <i class="fa fa-plus mr-1"></i>添加成员
                            </button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学号</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">职务</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">职责</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="committee-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- 班委会数据将通过JS动态加载 -->
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">加载班委会数据中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 值日安排页面 -->
                <div id="schedules-page" class="page-content hidden">
                    <div class="content-card">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                            <h3 class="text-lg font-semibold">值日安排管理</h3>
                            <div class="flex gap-4 w-full md:w-auto">
                                <div class="flex gap-2">
                                    <input type="date" id="schedule-start-date" class="px-4 py-2 border border-gray-300 rounded-md">
                                    <span class="flex items-center">至</span>
                                    <input type="date" id="schedule-end-date" class="px-4 py-2 border border-gray-300 rounded-md">
                                </div>
                                <select id="schedule-status-filter" class="px-4 py-2 border border-gray-300 rounded-md">
                                    <option value="">所有状态</option>
                                    <option value="未开始">未开始</option>
                                    <option value="进行中">进行中</option>
                                    <option value="已完成">已完成</option>
                                </select>
                                <button id="filter-schedules-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                                    <i class="fa fa-filter mr-1"></i>筛选
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">值日人员</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">任务描述</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                    </tr>
                                </thead>
                                <tbody id="schedules-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- 值日数据将通过JS动态加载 -->
                                    <tr>
                                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">加载值日数据中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 班级活动页面 -->
                <div id="activities-page" class="page-content hidden">
                    <div class="content-card">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                            <h3 class="text-lg font-semibold">班级活动管理</h3>
                            <div class="flex gap-4 w-full md:w-auto">
                                <div class="flex gap-2">
                                    <input type="date" id="activity-start-date" class="px-4 py-2 border border-gray-300 rounded-md">
                                    <span class="flex items-center">至</span>
                                    <input type="date" id="activity-end-date" class="px-4 py-2 border border-gray-300 rounded-md">
                                </div>
                                <select id="activity-type-filter" class="px-4 py-2 border border-gray-300 rounded-md">
                                    <option value="">所有类型</option>
                                    <option value="会议">会议</option>
                                    <option value="比赛">比赛</option>
                                    <option value="志愿活动">志愿活动</option>
                                    <option value="其他">其他</option>
                                </select>
                                <button id="filter-activities-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                                    <i class="fa fa-filter mr-1"></i>筛选
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">活动名称</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">负责人</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">详情</th>
                                    </tr>
                                </thead>
                                <tbody id="activities-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- 活动数据将通过JS动态加载 -->
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">加载活动数据中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 留言簿页面 -->
                <div id="messages-page" class="page-content hidden">
                    <div class="content-card">
                        <h3 class="text-lg font-semibold mb-6">班级留言簿</h3>
                        
                        <div class="mb-6">
                            <textarea id="new-message" rows="3" placeholder="输入留言内容..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"></textarea>
                            <div class="mt-2 flex justify-end">
                                <button id="send-message-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                                    <i class="fa fa-paper-plane mr-1"></i>发送留言
                                </button>
                            </div>
                        </div>

                        <div id="messages-list">
                            <!-- 留言数据将通过JS动态加载 -->
                            <p class="text-center text-gray-500 py-6">加载留言数据中...</p>
                        </div>
                    </div>
                </div>

                <!-- 实时聊天页面 -->
                <div id="chat-page" class="page-content hidden">
                    <div class="content-card h-[calc(100vh-12rem)] flex flex-col">
                        <div class="flex-1 flex">
                            <!-- 在线用户列表 -->
                            <div class="w-64 border-r border-gray-200 p-4">
                                <h4 class="font-medium mb-3">在线用户</h4>
                                <div id="online-users-list" class="space-y-2">
                                    <!-- 在线用户将通过WebSocket动态加载 -->
                                    <p class="text-sm text-gray-500">加载在线用户中...</p>
                                </div>
                            </div>
                            
                            <!-- 聊天内容 -->
                            <div class="flex-1 flex flex-col">
                                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                                    <!-- 聊天消息将通过WebSocket动态加载 -->
                                    <p class="text-center text-gray-500 py-6">等待连接...</p>
                                </div>
                                
                                <!-- 发送消息框 -->
                                <div class="border-t border-gray-200 p-4">
                                    <div class="flex gap-2">
                                        <input type="text" id="chat-input" placeholder="输入消息..."
                                            class="flex-1 px-4 py-2 border border-gray-300 rounded-md">
                                        <button id="send-chat-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                                            <i class="fa fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 添加成员模态框 -->
    <div id="add-member-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md p-6">
            <h3 class="text-lg font-semibold mb-4">添加班级成员</h3>
            <form id="add-member-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">学号/工号</label>
                    <input type="text" id="member-id" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                    <input type="text" id="member-name" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">角色</label>
                    <select id="member-role" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                        <option value="teacher">教师</option>
                        <option value="student">学生</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">联系电话</label>
                    <input type="text" id="member-phone"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                    <input type="email" id="member-email"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-add-member" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 全局变量
        let currentUser = null;
        let ws = null;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化侧边栏折叠/展开
            initSidebar();
            
            // 初始化导航切换
            initNavigation();
            
            // 初始化登录表单
            initLoginForm();
            
            // 初始化退出功能
            initLogout();

            // 检查本地存储中的登录状态
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
                loadDashboardData();
            }
        });

        // 初始化侧边栏折叠/展开
        function initSidebar() {
            document.querySelectorAll('.sidebar-category').forEach(category => {
                category.addEventListener('click', () => {
                    const categoryName = category.getAttribute('data-category');
                    const content = category.nextElementSibling;
                    const icon = category.querySelector('.fa-chevron-down');
                    
                    // 切换内容高度
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        content.style.maxHeight = content.scrollHeight + 'px';
                        icon.style.transform = 'rotate(180deg)';
                    }
                });
            });

            // 默认展开第一个分类
            const firstCategory = document.querySelector('.sidebar-category');
            if (firstCategory) {
                firstCategory.click();
            }
        }

        // 初始化导航切换
        function initNavigation() {
            document.querySelectorAll('.sidebar-link.nav-item').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // 更新活跃状态
                    document.querySelectorAll('.sidebar-link.nav-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    link.classList.add('active');
                    
                    // 切换页面
                    const targetPage = link.getAttribute('data-page');
                    document.querySelectorAll('.page-content').forEach(page => {
                        page.classList.add('hidden');
                    });
                    document.getElementById(`${targetPage}-page`).classList.remove('hidden');
                    
                    // 更新页面标题
                    const pageTitle = link.textContent.trim();
                    document.getElementById('page-title').textContent = pageTitle;

                    // 加载对应页面数据
                    if (targetPage === 'class-members') {
                        loadClassMembers();
                    } else if (targetPage === 'committee') {
                        loadCommitteeMembers();
                    } else if (targetPage === 'schedules') {
                        loadSchedules();
                    } else if (targetPage === 'activities') {
                        loadActivities();
                    } else if (targetPage === 'messages') {
                        loadMessages();
                    } else if (targetPage === 'chat') {
                        initWebSocket();
                    }
                });
            });
        }

        // 初始化登录表单
        function initLoginForm() {
            const form = document.getElementById('login-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const role = document.getElementById('user-role').value;
                
                try {
                    const response = await fetch('http://101.35.129.174:3000/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password, role })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        currentUser = data.user;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        showApp();
                        loadDashboardData();
                    } else {
                        alert(data.message || '登录失败');
                    }
                } catch (err) {
                    console.error('登录错误:', err);
                    alert('登录失败，请重试');
                }
            });
        }

        // 初始化退出功能
        function initLogout() {
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                currentUser = null;
                // 关闭WebSocket连接
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.close();
                }
                showLoginPage();
            });
        }

        // 显示应用界面
        function showApp() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('user-info').textContent = `${currentUser.username} (${getRoleText(currentUser.role)})`;
            document.getElementById('stat-current-user').textContent = `${currentUser.username} (${getRoleText(currentUser.role)})`;
            
            // 初始化功能按钮事件
            initFeatureEvents();
        }

        // 显示登录页面
        function showLoginPage() {
            document.getElementById('app').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('login-form').reset();
        }

        // 转换角色文本
        function getRoleText(role) {
            const roleMap = {
                'admin': '管理员',
                'teacher': '教师',
                'student': '学生'
            };
            return roleMap[role] || role;
        }

        // 初始化功能按钮事件
        function initFeatureEvents() {
            // 班级成员相关
            document.getElementById('add-member-btn').addEventListener('click', () => {
                document.getElementById('add-member-modal').classList.remove('hidden');
                document.getElementById('add-member-form').reset();
            });
            
            document.getElementById('cancel-add-member').addEventListener('click', () => {
                document.getElementById('add-member-modal').classList.add('hidden');
            });
            
            document.getElementById('add-member-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const memberData = {
                    id: document.getElementById('member-id').value,
                    name: document.getElementById('member-name').value,
                    role: document.getElementById('member-role').value,
                    phone: document.getElementById('member-phone').value,
                    email: document.getElementById('member-email').value
                };
                
                try {
                    const response = await fetch('http://101.35.129.174:3000/api/class-members', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(memberData)
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('add-member-modal').classList.add('hidden');
                        loadClassMembers(); // 重新加载成员列表
                        loadDashboardData(); // 更新仪表盘统计
                    } else {
                        alert('添加失败: ' + (data.error || '未知错误'));
                    }
                } catch (err) {
                    console.error('添加成员错误:', err);
                    alert('添加失败，请重试');
                }
            });

            // 成员搜索和筛选
            document.getElementById('member-search').addEventListener('input', debounce(loadClassMembers, 300));
            document.getElementById('member-role-filter').addEventListener('change', loadClassMembers);

            // 值日安排筛选
            document.getElementById('filter-schedules-btn').addEventListener('click', loadSchedules);

            // 班级活动筛选
            document.getElementById('filter-activities-btn').addEventListener('click', loadActivities);

            // 发送留言
            document.getElementById('send-message-btn').addEventListener('click', sendMessage);

            // 发送聊天消息
            document.getElementById('send-chat-btn').addEventListener('click', sendChatMessage);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
        }

        // 加载仪表盘数据
        async function loadDashboardData() {
            try {
                // 加载班级成员总数
                const membersResponse = await fetch('http://101.35.129.174:3000/api/class-members');
                const membersData = await membersResponse.json();
                document.getElementById('stat-total-members').textContent = membersData.length;

                // 加载本月活动数
                const today = new Date();
                const monthStart = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-01`;
                const activitiesResponse = await fetch(`http://101.35.129.174:3000/api/activities?startDate=${monthStart}`);
                const activitiesData = await activitiesResponse.json();
                document.getElementById('stat-monthly-activities').textContent = activitiesData.length;

                // 加载最新留言数
                const messagesResponse = await fetch('http://101.35.129.174:3000/api/messages');
                const messagesData = await messagesResponse.json();
                document.getElementById('stat-recent-messages').textContent = messagesData.length;

                // 加载活动统计图表
                loadActivitiesStats();

                // 加载值日统计图表
                loadSchedulesStats();
            } catch (err) {
                console.error('加载仪表盘数据错误:', err);
            }
        }

        // 加载班级成员列表
        async function loadClassMembers() {
            const search = document.getElementById('member-search').value;
            const role = document.getElementById('member-role-filter').value;
            
            try {
                let url = 'http://101.35.129.174:3000/api/class-members';
                const params = new URLSearchParams();
                if (search) params.append('search', search);
                if (role) params.append('role', role);
                if (params.toString()) url += '?' + params.toString();
                
                const response = await fetch(url);
                const members = await response.json();
                const tableBody = document.getElementById('members-table-body');
                
                if (members.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">没有找到成员数据</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = members.map(member => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${member.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${member.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${getRoleText(member.role)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${member.phone || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button class="text-red-500 hover:text-red-700 transition-colors" 
                                onclick="deleteClassMember('${member.id}')">
                                <i class="fa fa-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('加载班级成员错误:', err);
                document.getElementById('members-table-body').innerHTML = 
                    '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">加载失败，请重试</td></tr>';
            }
        }

        // 删除班级成员
        async function deleteClassMember(memberId) {
            if (!confirm('确定要删除这个成员吗？')) return;
            
            try {
                const response = await fetch(`http://101.35.129.174:3000/api/class-members/${memberId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (data.success) {
                    loadClassMembers();
                    loadDashboardData();
                } else {
                    alert('删除失败: ' + (data.error || '未知错误'));
                }
            } catch (err) {
                console.error('删除成员错误:', err);
                alert('删除失败，请重试');
            }
        }

        // 加载班委会成员
        async function loadCommitteeMembers() {
            try {
                const response = await fetch('http://101.35.129.174:3000/api/committee');
                const members = await response.json();
                const tableBody = document.getElementById('committee-table-body');
                
                if (members.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">没有班委会数据</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = members.map(member => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${member.student_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${member.name || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${member.position}</td>
                        <td class="px-6 py-4">${member.responsibilities || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button class="text-red-500 hover:text-red-700 transition-colors" 
                                onclick="deleteCommitteeMember(${member.id})">
                                <i class="fa fa-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('加载班委会成员错误:', err);
                document.getElementById('committee-table-body').innerHTML = 
                    '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">加载失败，请重试</td></tr>';
            }
        }

        // 删除班委会成员
        async function deleteCommitteeMember(id) {
            if (!confirm('确定要删除这个班委会成员吗？')) return;
            
            try {
                const response = await fetch(`http://101.35.129.174:3000/api/committee/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (data.success) {
                    loadCommitteeMembers();
                } else {
                    alert('删除失败: ' + (data.error || '未知错误'));
                }
            } catch (err) {
                console.error('删除班委会成员错误:', err);
                alert('删除失败，请重试');
            }
        }

        // 加载值日安排
        async function loadSchedules() {
            const startDate = document.getElementById('schedule-start-date').value;
            const endDate = document.getElementById('schedule-end-date').value;
            const status = document.getElementById('schedule-status-filter').value;
            
            try {
                let url = 'http://101.35.129.174:3000/api/schedules';
                const params = new URLSearchParams();
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (status) params.append('status', status);
                if (params.toString()) url += '?' + params.toString();
                
                const response = await fetch(url);
                const schedules = await response.json();
                const tableBody = document.getElementById('schedules-table-body');
                
                if (schedules.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">没有找到值日数据</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = schedules.map(schedule => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${schedule.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${schedule.personnel}</td>
                        <td class="px-6 py-4">${schedule.task}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 rounded text-xs ${getStatusClass(schedule.status)}">
                                ${schedule.status}
                            </span>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('加载值日安排错误:', err);
                document.getElementById('schedules-table-body').innerHTML = 
                    '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">加载失败，请重试</td></tr>';
            }
        }

        // 获取状态样式
        function getStatusClass(status) {
            const statusMap = {
                '未开始': 'bg-yellow-100 text-yellow-800',
                '进行中': 'bg-blue-100 text-blue-800',
                '已完成': 'bg-green-100 text-green-800'
            };
            return statusMap[status] || 'bg-gray-100 text-gray-800';
        }

        // 加载班级活动
        async function loadActivities() {
            const startDate = document.getElementById('activity-start-date').value;
            const endDate = document.getElementById('activity-end-date').value;
            const type = document.getElementById('activity-type-filter').value;
            
            try {
                let url = 'http://101.35.129.174:3000/api/activities';
                const params = new URLSearchParams();
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (type) params.append('type', type);
                if (params.toString()) url += '?' + params.toString();
                
                const response = await fetch(url);
                const activities = await response.json();
                const tableBody = document.getElementById('activities-table-body');
                
                if (activities.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">没有找到活动数据</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = activities.map(activity => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${activity.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${activity.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${activity.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${activity.creator || '-'}</td>
                        <td class="px-6 py-4">${activity.description || '-'}</td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('加载班级活动错误:', err);
                document.getElementById('activities-table-body').innerHTML = 
                    '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">加载失败，请重试</td></tr>';
            }
        }

        // 加载留言
        async function loadMessages() {
            try {
                const response = await fetch('http://101.35.129.174:3000/api/messages');
                const messages = await response.json();
                const messagesList = document.getElementById('messages-list');
                
                if (messages.length === 0) {
                    messagesList.innerHTML = '<p class="text-center text-gray-500 py-6">暂无留言</p>';
                    return;
                }
                
                messagesList.innerHTML = messages.map(msg => `
                    <div class="message-item">
                        <div class="flex justify-between items-start">
                            <span class="font-medium">${msg.username}</span>
                            <span class="text-xs text-gray-500">${formatDate(msg.created_at)}</span>
                        </div>
                        <p class="mt-1 text-gray-700">${msg.content}</p>
                    </div>
                `).join('');
            } catch (err) {
                console.error('加载留言错误:', err);
                document.getElementById('messages-list').innerHTML = 
                    '<p class="text-center text-red-500 py-6">加载失败，请重试</p>';
            }
        }

        // 发送留言
        async function sendMessage() {
            const content = document.getElementById('new-message').value.trim();
            if (!content) return;
            
            try {
                const response = await fetch('http://101.35.129.174:3000/api/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, userId: currentUser.id })
                });
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('new-message').value = '';
                    loadMessages();
                    loadDashboardData();
                } else {
                    alert('发送失败: ' + (data.error || '未知错误'));
                }
            } catch (err) {
                console.error('发送留言错误:', err);
                alert('发送失败，请重试');
            }
        }

        // 初始化WebSocket连接（实时聊天）
        function initWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) return;
            
            // 连接WebSocket服务器
            ws = new WebSocket(`ws://101.35.129.174:3000`);
            
            // 连接成功
            ws.onopen = () => {
                console.log('WebSocket连接成功');
                // 发送登录信息
                ws.send(JSON.stringify({
                    type: 'login',
                    userId: currentUser.id,
                    username: currentUser.username
                }));
                document.getElementById('chat-messages').innerHTML = '<p class="text-center text-green-500 py-6">已连接，可以开始聊天</p>';
            };
            
            // 接收消息
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    const chatMessages = document.getElementById('chat-messages');
                    
                    // 处理在线用户列表
                    if (data.type === 'userList') {
                        const onlineUsersList = document.getElementById('online-users-list');
                        onlineUsersList.innerHTML = data.users.map(user => `
                            <div class="flex items-center">
                                <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                                <span>${user.username}</span>
                            </div>
                        `).join('');
                        return;
                    }
                    
                    // 处理聊天消息
                    if (data.type === 'message') {
                        const isCurrentUser = data.username === currentUser.username;
                        const messageHtml = `
                            <div class="flex ${isCurrentUser ? 'justify-end' : 'justify-start'}">
                                <div class="${isCurrentUser ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'} px-4 py-2 rounded-md max-w-xs">
                                    <div class="font-medium text-sm">${data.username}</div>
                                    <div class="mt-1">${data.content}</div>
                                </div>
                            </div>
                        `;
                        chatMessages.innerHTML += messageHtml;
                        // 滚动到底部
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                } catch (err) {
                    console.error('处理WebSocket消息错误:', err);
                }
            };
            
            // 连接关闭
            ws.onclose = () => {
                console.log('WebSocket连接关闭');
                document.getElementById('chat-messages').innerHTML = '<p class="text-center text-red-500 py-6">连接已关闭，请刷新页面重试</p>';
                document.getElementById('online-users-list').innerHTML = '<p class="text-sm text-gray-500">已断开连接</p>';
            };
            
            // 连接错误
            ws.onerror = (err) => {
                console.error('WebSocket错误:', err);
                document.getElementById('chat-messages').innerHTML = '<p class="text-center text-red-500 py-6">连接错误，请重试</p>';
            };
        }

        // 发送聊天消息
        function sendChatMessage() {
            const content = document.getElementById('chat-input').value.trim();
            if (!content || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            // 发送消息
            ws.send(JSON.stringify({
                type: 'message',
                username: currentUser.username,
                content: content
            }));
            
            // 清空输入框
            document.getElementById('chat-input').value = '';
        }

        // 加载活动统计图表
        async function loadActivitiesStats() {
            try {
                const response = await fetch('http://101.35.129.174:3000/api/activities/stats');
                const stats = await response.json();
                const chartContainer = document.getElementById('activities-chart');
                
                if (stats.length === 0) {
                    chartContainer.innerHTML = '<p class="text-gray-500">暂无活动数据</p>';
                    return;
                }
                
                // 简单的文本图表展示
                let chartHtml = '<div class="space-y-2">';
                stats.forEach(item => {
                    const barWidth = Math.min(item.count * 50, 400); // 最大宽度400px
                    chartHtml += `
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm">${item.month}</span>
                                <span class="text-sm font-medium">${item.count}个活动</span>
                            </div>
                            <div class="h-4 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-blue-500" style="width: ${barWidth}px"></div>
                            </div>
                        </div>
                    `;
                });
                chartHtml += '</div>';
                chartContainer.innerHTML = chartHtml;
            } catch (err) {
                console.error('加载活动统计错误:', err);
                document.getElementById('activities-chart').innerHTML = '<p class="text-red-500">加载统计失败</p>';
            }
        }

        // 加载值日统计图表
        async function loadSchedulesStats() {
            try {
                const response = await fetch('http://101.35.129.174:3000/api/schedules/stats');
                const stats = await response.json();
                const chartContainer = document.getElementById('schedules-chart');
                
                // 简单的文本图表展示
                chartContainer.innerHTML = `
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-3xl font-bold text-green-500 mb-1">${stats.completedPercentage}%</div>
                            <div class="text-sm text-gray-600">已完成</div>
                            <div class="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-green-500" style="width: ${stats.completedPercentage}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="text-3xl font-bold text-blue-500 mb-1">${stats.inProgressPercentage}%</div>
                            <div class="text-sm text-gray-600">进行中</div>
                            <div class="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-blue-500" style="width: ${stats.inProgressPercentage}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="text-3xl font-bold text-yellow-500 mb-1">${stats.notStartedPercentage}%</div>
                            <div class="text-sm text-gray-600">未开始</div>
                            <div class="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-yellow-500" style="width: ${stats.notStartedPercentage}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('加载值日统计错误:', err);
                document.getElementById('schedules-chart').innerHTML = '<p class="text-red-500">加载统计失败</p>';
            }
        }

        // 工具函数：日期格式化
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 工具函数：防抖
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
    </script>
</body>
</html>
